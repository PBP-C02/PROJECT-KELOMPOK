{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>MoveBuddy - {{ coach.title }}</title>
<link rel="stylesheet" href="{% static 'coach/coach_detail.css' %}">
{% endblock meta %}

{% block content %}
<div class="detail-container">
  <!-- Header Banner -->
  <div class="detail-header">
    {% if coach.image %}
      <img src="{{ coach.image.url }}" alt="{{ coach.title }}" class="header-image">
    {% else %}
      <div class="header-placeholder">
        <span>{{ coach.category|upper }}</span>
      </div>
    {% endif %}
    
    <!-- Ribbon Booked -->
    {% if coach.isBooked %}
    <div class="ribbon-wrapper">
      <div class="ribbon">BOOKED</div>
    </div>
    {% endif %}
  </div>

  <!-- Main Content -->
  <div class="detail-content">
    <!-- Status Badge -->
    <div class="status-badge {% if not coach.isBooked %}available{% else %}booked{% endif %}">
      {% if not coach.isBooked %}Available{% else %}Booked{% endif %}
    </div>

    <!-- Title & Info -->
    <h1 class="detail-title">{{ coach.title }}</h1>
    <div class="detail-meta">
      <span class="meta-item">{{ coach.get_category_display }}</span>
      <span class="meta-separator">•</span>
      <span class="meta-item">Rating: ⭐ {{ coach.rating }}</span>
      <span class="meta-separator">•</span>
      <span class="meta-item">{{ coach.location }}</span>
    </div>

    <!-- Price Box -->
    <div class="price-box">
      <span class="price-label">Price per Session</span>
      <span class="price-value">IDR {{ coach.price|floatformat:0 }}</span>
    </div>

    <!-- Description -->
    <div class="detail-section">
      <h2 class="section-title">Description</h2>
      <p class="section-content">{{ coach.description }}</p>
    </div>

    <!-- Address -->
    <div class="detail-section">
      <h2 class="section-title">Address</h2>
      <p class="section-content">{{ coach.address }}</p>
      {% if coach.mapsLink %}
        <a href="{{ coach.mapsLink }}" target="_blank" rel="noopener" 
           style="display:inline-flex; align-items:center; gap:6px; color:#667eea; margin-top:8px; text-decoration:none;">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
            <circle cx="12" cy="10" r="3"></circle>
          </svg>
          Open in Google Maps
        </a>
      {% endif %}
    </div>

    <!-- Schedule -->
    <div class="detail-section">
      <h2 class="section-title">Schedule</h2>
      <div class="schedule-info">
        <div class="schedule-item">
          <span class="schedule-label">Date:</span>
          <span class="schedule-value">{{ coach.date|date:"l, d F Y" }}</span>
        </div>
        <div class="schedule-item">
          <span class="schedule-label">Time:</span>
          <span class="schedule-value">{{ coach.startTime|time:"H:i" }} - {{ coach.endTime|time:"H:i" }}</span>
        </div>
      </div>
    </div>

    <!-- Coach Info -->
    <div class="detail-section">
      <h2 class="section-title">Coach Information</h2>
      <div class="coach-info">
        <div class="coach-item">
          <span class="coach-label">Name:</span>
          <span class="coach-value">{{ coach.user.nama }}</span>
        </div>
        {% if coach.instagram_link %}
        <div class="coach-item">
          <span class="coach-label">Instagram:</span>
          <a href="{{ coach.instagram_link }}" target="_blank" class="coach-instagram">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
              <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
              <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
            </svg>
            View Instagram
          </a>
        </div>
        {% endif %}
      </div>
    </div>

    <div class="back-action">
      <a href="{% url 'coach:show_main' %}" class="btn-back">← Back to Coach List</a>
      
      {% if request.user != coach.user and not coach.isBooked %}
        <button type="button" class="btn-book-small" onclick="bookCoach('{{ coach.pk }}')">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
          Book
        </button>
      {% elif coach.peserta == request.user %}
        <button type="button" class="btn-cancel-small" onclick="cancelBooking('{{ coach.pk }}')">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
          Cancel
        </button>
      {% endif %}
    </div>
  </div>
</div>

<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function bookCoach(coachId) {
  const btn = event.target.closest('button');
  const originalHTML = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = `
    <svg class="spinner-small" viewBox="0 0 24 24" style="width:14px;height:14px;">
      <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
    </svg>
    <span>Booking...</span>
  `;
  
  fetch(`/coach/book-coach/${coachId}/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({})
  })
  .then(response => {
    if (!response.ok) {
      return response.json().then(err => Promise.reject(err));
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      location.reload();
    } else {
      alert(data.message || 'Booking failed');
      btn.disabled = false;
      btn.innerHTML = originalHTML;
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert(error.message || 'An error occurred. Please try again.');
    btn.disabled = false;
    btn.innerHTML = originalHTML;
  });
}

function cancelBooking(coachId) {
  const btn = event.target.closest('button');
  const originalHTML = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = `
    <svg class="spinner-small" viewBox="0 0 24 24" style="width:14px;height:14px;">
      <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
    </svg>
    <span>Cancelling...</span>
  `;
  
  fetch(`/coach/cancel-booking/${coachId}/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({})
  })
  .then(response => {
    if (!response.ok) {
      return response.json().then(err => Promise.reject(err));
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      location.reload();
    } else {
      alert(data.message || 'Cancellation failed');
      btn.disabled = false;
      btn.innerHTML = originalHTML;
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert(error.message || 'An error occurred. Please try again.');
    btn.disabled = false;
    btn.innerHTML = originalHTML;
  });
}
</script>
{% endblock %}
