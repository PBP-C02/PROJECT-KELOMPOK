{% extends 'coach_base.html' %}
{% load static %}

{% block meta %}
<title>MoveBuddy - Search Your Coach</title>
<link rel="stylesheet" href="{% static 'coach/main.css' %}">
{% endblock meta %}

{% block content %}
{% include 'includes/navbar.html' %}

<div style="--bg-image: url('{% static 'img/pattern.png' %}');" class="coach-bg-wrapper">
<div class="container">

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display:none;">
  <div class="loading-spinner">
    <div class="spinner"></div>
    <p>Loading coaches...</p>
  </div>
</div>

<!-- Error Message -->
<div id="errorMessage" class="error-banner" style="display:none;">
  <div class="error-content">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="8" x2="12" y2="12"></line>
      <line x1="12" y1="16" x2="12.01" y2="16"></line>
    </svg>
    <span id="errorText">An error occurred</span>
    <button onclick="hideError()" class="error-close">×</button>
  </div>
</div>

<!-- Search Form -->
<div class="search-bar">
  <div style="display:flex; gap:12px; align-items:center; width:100%;">
    <input 
      type="text" 
      id="searchInput"
      placeholder="Cari coach atau lokasi..." 
      style="flex:1; min-width:0;">
    
    <select id="locationFilter" style="min-width:150px;">
      <option value="">All Locations</option>
      <option value="Jakarta">Jakarta</option>
      <option value="Bandung">Bandung</option>
      <option value="Surabaya">Surabaya</option>
      <option value="Depok">Depok</option>
      <option value="Tangerang">Tangerang</option>
      <option value="Bekasi">Bekasi</option>
      <option value="Yogyakarta">Yogyakarta</option>
      <option value="Medan">Medan</option>
      <option value="Bogor">Bogor</option>
      <option value="Denpasar">Denpasar</option>
    </select>

    <button type="button" id="btn-price" class="btn-outline" style="white-space:nowrap;">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="12" y1="1" x2="12" y2="23"></line>
        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
      </svg>
      <span id="priceLabel">Price</span>
    </button>
  </div>

  <!-- Price Modal -->
  <dialog id="price-modal" class="mb-modal">
    <div class="mb-modal-body">
      <h3>Filter Harga</h3>
      <div class="mb-field">
        <span>Harga Minimum (Rp)</span>
        <input type="text" id="price_min_field" placeholder="0">
      </div>
      <div class="mb-field">
        <span>Harga Maksimum (Rp)</span>
        <input type="text" id="price_max_field" placeholder="Tidak terbatas">
      </div>
      <div class="mb-actions">
        <button type="button" id="price-clear" class="btn-secondary-modal">Bersihkan</button>
        <button type="button" id="price-cancel" class="btn-secondary-modal">Batal</button>
        <button type="button" id="price-apply" class="btn-primary">Terapkan</button>
      </div>
    </div>
  </dialog>

  <!-- Category Pills -->
  <div style="display:flex; gap:8px; margin-top:16px; flex-wrap:wrap;">
    <button type="button" class="category-pill active" data-category="" onclick="filterCategory(this, '')">All</button>
    <button type="button" class="category-pill" data-category="badminton" onclick="filterCategory(this, 'badminton')">Badminton</button>
    <button type="button" class="category-pill" data-category="basketball" onclick="filterCategory(this, 'basketball')">Basketball</button>
    <button type="button" class="category-pill" data-category="soccer" onclick="filterCategory(this, 'soccer')">Soccer</button>
    <button type="button" class="category-pill" data-category="tennis" onclick="filterCategory(this, 'tennis')">Tennis</button>
    <button type="button" class="category-pill" data-category="volleyball" onclick="filterCategory(this, 'volleyball')">Volleyball</button>
    <button type="button" class="category-pill" data-category="paddle" onclick="filterCategory(this, 'paddle')">Paddle</button>
    <button type="button" class="category-pill" data-category="futsal" onclick="filterCategory(this, 'futsal')">Futsal</button>
    <button type="button" class="category-pill" data-category="table_tennis" onclick="filterCategory(this, 'table_tennis')">Table Tennis</button>
    <button type="button" class="category-pill" data-category="swimming" onclick="filterCategory(this, 'swimming')">Swimming</button>
  </div>

  <!-- Available coaches checkbox + Add Coach button -->
  <div class="filter-footer">
    <div class="filter-left">
      <label class="avail-check">
        <input type="checkbox" id="availableOnly">
        Hanya tampilkan yang tersedia
      </label>
    </div>
    <a href="{% url 'coach:create_coach_page' %}" class="btn-add">+ Tambah Coach</a>
  </div>
</div>

<!-- View Mode -->
<div class="view-mode-container">
  <div class="view-mode-group">
    <button type="button" class="view-mode-btn active" data-view="all" onclick="changeViewMode(this, 'all')">All</button>
    <button type="button" class="view-mode-btn" data-view="my_bookings" onclick="changeViewMode(this, 'my_bookings')">My Bookings</button>
    <button type="button" class="view-mode-btn" data-view="my_coaches" onclick="changeViewMode(this, 'my_coaches')">My Coaches</button>
  </div>
</div>

<!-- Meta Info -->
<div class="meta-wrap">
  <div class="meta-left" id="coachCount">Menampilkan 0 coach</div>
  <div class="meta-right">
    <label class="sort-inline">
      <span>Urutkan berdasarkan:</span>
      <select id="sortBy">
        <option value="date_asc">Tanggal Terdekat</option>
        <option value="date_desc">Tanggal Terbaru</option>
        <option value="price_asc">Harga Terendah</option>
        <option value="price_desc">Harga Tertinggi</option>
      </select>
    </label>
  </div>
</div>

<!-- Coach Cards Container -->
<div id="coachGrid" class="cards"></div>

<!-- Loading State -->
<div id="loadingState" class="hidden" style="text-align:center; padding:3rem;">
  <div class="spinner" style="margin:0 auto 1rem;"></div>
  <p style="color:#64748b;">Loading coaches...</p>
</div>

<!-- Empty State -->
<div id="emptyState" class="empty-state" style="display:none;">
  <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
    <circle cx="12" cy="7" r="4"></circle>
    <line x1="23" y1="21" x2="1" y2="21"></line>
  </svg>
  <h3>No Coaches Found</h3>
  <p>Try adjusting your search filters</p>
  <a href="{% url 'coach:create_coach_page' %}" class="btn-add-empty">+ Add First Coach</a>
</div>

</div>
</div>

<script>
// ==================== CONSTANTS ====================
const PERSON_PLACEHOLDER = 'https://www.svgrepo.com/show/506667/person.svg';

// ==================== STATE MANAGEMENT ====================
let currentFilters = {
  search: '',
  location: '',
  category: '',
  minPrice: '',
  maxPrice: '',
  available: false,
  view: 'all',
  sort: 'date_asc'
};

let searchTimeout = null;

// ==================== INITIALIZATION ====================
window.addEventListener('load', function() {
  loadCoaches();
  setupEventListeners();
});

function setupEventListeners() {
  // Search with debounce
  document.getElementById('searchInput').addEventListener('input', function(e) {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      currentFilters.search = e.target.value;
      loadCoaches();
    }, 500);
  });

  // Location filter
  document.getElementById('locationFilter').addEventListener('change', function(e) {
    currentFilters.location = e.target.value;
    loadCoaches();
  });

  // Available only checkbox
  document.getElementById('availableOnly').addEventListener('change', function(e) {
    currentFilters.available = e.target.checked;
    loadCoaches();
  });

  // Sort by
  document.getElementById('sortBy').addEventListener('change', function(e) {
    currentFilters.sort = e.target.value;
    loadCoaches();
  });
}

// ==================== CATEGORY FILTER ====================
function filterCategory(element, category) {
  document.querySelectorAll('.category-pill').forEach(pill => {
    pill.classList.remove('active');
  });
  element.classList.add('active');
  
  currentFilters.category = category;
  loadCoaches();
}

// ==================== VIEW MODE ====================
function changeViewMode(element, mode) {
  document.querySelectorAll('.view-mode-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  element.classList.add('active');
  
  currentFilters.view = mode;
  loadCoaches();
}

// ==================== PRICE MODAL ====================
(function () {
  const dlg = document.getElementById('price-modal');
  const btnOpen = document.getElementById('btn-price');
  const btnApply = document.getElementById('price-apply');
  const btnCancel = document.getElementById('price-cancel');
  const btnClear = document.getElementById('price-clear');
  const minField = document.getElementById('price_min_field');
  const maxField = document.getElementById('price_max_field');
  const labelSpan = document.getElementById('priceLabel');

  function onlyDigits(s){ return (s || '').replace(/[^\d]/g,''); }
  function fmtIDR(n){
    if(!n) return '';
    return 'Rp ' + String(n).replace(/\B(?=(\d{3})+(?!\d))/g, '.');
  }
  
  function updateButtonLabel(){
    const a = currentFilters.minPrice;
    const b = currentFilters.maxPrice;
    if (a || b) {
      labelSpan.textContent = `${fmtIDR(a || 0)} – ${fmtIDR(b || '') || '∞'}`;
    } else {
      labelSpan.textContent = 'Price';
    }
  }

  btnOpen.addEventListener('click', () => {
    minField.value = currentFilters.minPrice || '';
    maxField.value = currentFilters.maxPrice || '';
    if (typeof dlg.showModal === 'function') dlg.showModal();
    else dlg.setAttribute('open',''); 
  });

  btnApply.addEventListener('click', () => {
    currentFilters.minPrice = onlyDigits(minField.value);
    currentFilters.maxPrice = onlyDigits(maxField.value);
    updateButtonLabel();
    dlg.close();
    loadCoaches();
  });

  btnClear.addEventListener('click', () => {
    currentFilters.minPrice = '';
    currentFilters.maxPrice = '';
    minField.value = '';
    maxField.value = '';
    updateButtonLabel();
    dlg.close();
    loadCoaches();
  });

  btnCancel.addEventListener('click', () => dlg.close());

  updateButtonLabel();
})();

// ==================== LOAD COACHES (AJAX) ====================
function loadCoaches() {
  const coachGrid = document.getElementById('coachGrid');
  const loadingState = document.getElementById('loadingState');
  const emptyState = document.getElementById('emptyState');
  const coachCount = document.getElementById('coachCount');
  
  // Show loading
  coachGrid.innerHTML = '';
  loadingState.classList.remove('hidden');
  emptyState.style.display = 'none';
  
  // Build query params
  let url = '{% url "coach:ajax_search" %}?';
  if (currentFilters.search) url += `q=${encodeURIComponent(currentFilters.search)}&`;
  if (currentFilters.location) url += `location=${encodeURIComponent(currentFilters.location)}&`;
  if (currentFilters.category) url += `category=${currentFilters.category}&`;
  if (currentFilters.minPrice) url += `min_price=${currentFilters.minPrice}&`;
  if (currentFilters.maxPrice) url += `max_price=${currentFilters.maxPrice}&`;
  if (currentFilters.available) url += `available=true&`;
  url += `view=${currentFilters.view}&`;
  url += `sort=${currentFilters.sort}`;
  
  // Fetch coaches
  fetch(url)
    .then(response => response.json())
    .then(data => {
      loadingState.classList.add('hidden');
      
      if (data.success && data.coaches && data.coaches.length > 0) {
        renderCoaches(data.coaches);
        coachCount.textContent = `Menampilkan ${data.count} coach`;
      } else {
        emptyState.style.display = 'block';
        coachCount.textContent = 'Menampilkan 0 coach';
      }
    })
    .catch(error => {
      console.error('Error loading coaches:', error);
      loadingState.classList.add('hidden');
      showError('Failed to load coaches. Please try again.');
    });
}

// ==================== RENDER COACHES ====================
function renderCoaches(coaches) {
  const coachGrid = document.getElementById('coachGrid');
  
  coachGrid.innerHTML = coaches.map(coach => `
    <div class="coach-card" onclick="window.location.href='${coach.detail_url}'">
      <!-- Thumbnail -->
      <div class="coach-thumb">
        ${coach.image_url ? 
          `<img src="${coach.image_url}" alt="${escapeHtml(coach.title)}" onerror="this.src='${PERSON_PLACEHOLDER}'">` :
          `<img src="${PERSON_PLACEHOLDER}" alt="${escapeHtml(coach.title)}">`
        }
      </div>

      <!-- Content -->
      <div class="coach-card-content">
        <!-- Status Badge -->
        <span class="coach-status-badge-inline ${!coach.is_booked ? 'available' : 'booked'}">
          ${!coach.is_booked ? 'Tersedia' : 'Booked'}
        </span>
        
        <!-- Title -->
        <h3>${escapeHtml(coach.title)}</h3>
        
        <!-- Info -->
        <div class="coach-info">
          <div class="coach-info-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 4.14 2.71 2.71 4.14l1.43 1.43L2 7.71l1.43 1.43L2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22l1.43-1.43L16.29 22l2.14-2.14 1.43 1.43 1.43-1.43-1.43-1.43L22 16.29z"/>
            </svg>
            <span>${coach.category_display}</span>
          </div>

          <div class="coach-info-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="m9.69 18.933.003.001C9.89 19.02 10 19 10 19s.11.02.308-.066l.002-.001.006-.003.018-.008a5.741 5.741 0 0 0 .281-.14c.186-.096.446-.24.757-.433.62-.384 1.445-.966 2.274-1.765C15.302 14.988 17 12.493 17 9A7 7 0 1 0 3 9c0 3.492 1.698 5.988 3.355 7.584a13.731 13.731 0 0 0 2.273 1.765 11.842 11.842 0 0 0 .976.544l.062.029.018.008.006.003ZM10 11.25a2.25 2.25 0 1 0 0-4.5 2.25 2.25 0 0 0 0 4.5Z" clip-rule="evenodd"/>
            </svg>
            <span>${escapeHtml(coach.location)}</span>
          </div>
          
          <div class="coach-info-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path d="M5.25 12a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75H6a.75.75 0 0 1-.75-.75V12ZM6 13.25a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75V14a.75.75 0 0 0-.75-.75H6ZM7.25 12a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75H8a.75.75 0 0 1-.75-.75V12ZM8 13.25a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75V14a.75.75 0 0 0-.75-.75H8ZM9.25 10a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75H10a.75.75 0 0 1-.75-.75V10ZM10 11.25a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75V12a.75.75 0 0 0-.75-.75H10ZM9.25 14a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75H10a.75.75 0 0 1-.75-.75V14ZM12 9.25a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75V10a.75.75 0 0 0-.75-.75H12ZM11.25 12a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75H12a.75.75 0 0 1-.75-.75V12ZM12 13.25a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75V14a.75.75 0 0 0-.75-.75H12ZM13.25 10a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75H14a.75.75 0 0 1-.75-.75V10ZM14 11.25a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75V12a.75.75 0 0 0-.75-.75H14Z"/>
              <path fill-rule="evenodd" d="M5.75 2a.75.75 0 0 1 .75.75V4h7V2.75a.75.75 0 0 1 1.5 0V4h.25A2.75 2.75 0 0 1 18 6.75v8.5A2.75 2.75 0 0 1 15.25 18H4.75A2.75 2.75 0 0 1 2 15.25v-8.5A2.75 2.75 0 0 1 4.75 4H5V2.75A.75.75 0 0 1 5.75 2Zm-1 5.5c-.69 0-1.25.56-1.25 1.25v6.5c0 .69.56 1.25 1.25 1.25h10.5c.69 0 1.25-.56 1.25-1.25v-6.5c0-.69-.56-1.25-1.25-1.25H4.75Z" clip-rule="evenodd"/>
            </svg>
            <span>${coach.date_formatted}</span>
          </div>
          
          <div class="coach-info-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm.75-13a.75.75 0 0 0-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 0 0 0-1.5h-3.25V5Z" clip-rule="evenodd"/>
            </svg>
            <span>${coach.start_time} - ${coach.end_time}</span>
          </div>
          
          <div class="coach-info-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path d="M10 9a3 3 0 1 0 0-6 3 3 0 0 0 0 6ZM6 8a2 2 0 1 1-4 0 2 2 0 0 1 4 0ZM1.49 15.326a.78.78 0 0 1-.358-.442 3 3 0 0 1 4.308-3.516 6.484 6.484 0 0 0-1.905 3.959c-.023.222-.014.442.025.654a4.97 4.97 0 0 1-2.07-.655ZM16.44 15.98a4.97 4.97 0 0 0 2.07-.654.78.78 0 0 0 .357-.442 3 3 0 0 0-4.308-3.517 6.484 6.484 0 0 1 1.907 3.96 2.32 2.32 0 0 1-.026.654ZM18 8a2 2 0 1 1-4 0 2 2 0 0 1 4 0ZM5.304 16.19a.844.844 0 0 1-.277-.71 5 5 0 0 1 9.947 0 .843.843 0 0 1-.277.71A6.975 6.975 0 0 1 10 18a6.974 6.974 0 0 1-4.696-1.81Z"/>
            </svg>
            <span>${escapeHtml(coach.user_name)}</span>
          </div>
        </div>

        <!-- Price -->
        <div class="coach-price">
          ${coach.price_formatted} <small>/sesi</small>
        </div>

        <!-- Action Buttons -->
        <div class="coach-card-actions" onclick="event.stopPropagation();">
          ${coach.is_owner ? 
            `<a href="${coach.edit_url}" class="btn-edit-card">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path d="m5.433 13.917 1.262-3.155A4 4 0 0 1 7.58 9.42l6.92-6.918a2.121 2.121 0 0 1 3 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 0 1-.65-.65Z"/>
                <path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0 0 10 3H4.75A2.75 2.75 0 0 0 2 5.75v9.5A2.75 2.75 0 0 0 4.75 18h9.5A2.75 2.75 0 0 0 17 15.25V10a.75.75 0 0 0-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5Z"/>
              </svg>
              Edit
            </a>` : ''
          }
          <button type="button" class="btn-detail-booking" onclick="window.location.href='${coach.detail_url}'">
            Lihat Detail & Booking
          </button>
        </div>
      </div>
    </div>
  `).join('');
}

// ==================== UTILITY FUNCTIONS ====================
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function showError(message) {
  document.getElementById('errorText').textContent = message;
  document.getElementById('errorMessage').style.display = 'block';
  setTimeout(() => hideError(), 5000);
}

function hideError() {
  document.getElementById('errorMessage').style.display = 'none';
}
</script>
{% endblock content %}
