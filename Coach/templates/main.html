{% extends 'coach_base.html' %}
{% load static %}

{% block meta %}
<title>MoveBuddy - Search Your Coach</title>
<link rel="stylesheet" href="{% static 'coach/main.css' %}">
{% endblock meta %}

{% block content %}
{% include 'includes/navbar.html' %}

<div style="--bg-image: url('{% static 'img/pattern.png' %}');" class="coach-bg-wrapper">
<div class="container">

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display:none;">
  <div class="loading-spinner">
    <div class="spinner"></div>
    <p>Loading coaches...</p>
  </div>
</div>

<!-- Error Message -->
<div id="errorMessage" class="error-banner" style="display:none;">
  <div class="error-content">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="8" x2="12" y2="12"></line>
      <line x1="12" y1="16" x2="12.01" y2="16"></line>
    </svg>
    <span id="errorText">An error occurred</span>
    <button onclick="hideError()" class="error-close">√ó</button>
  </div>
</div>

<!-- Search Form -->
<form id="filter-form" class="search-bar" method="get" action="{% url 'coach:show_main' %}">
  <div style="display:flex; gap:12px; align-items:center; width:100%;">
    <input 
      type="text" 
      name="nama_coach" 
      placeholder="Search coaches..." 
      value="{{ nama_coach|escape }}"
      style="flex:1; min-width:0;">
    
    <select name="location" style="min-width:150px;">
      <option value="">All Locations</option>
      <option value="Jakarta" {% if request.GET.location == 'Jakarta' %}selected{% endif %}>Jakarta</option>
      <option value="Bandung" {% if request.GET.location == 'Bandung' %}selected{% endif %}>Bandung</option>
      <option value="Surabaya" {% if request.GET.location == 'Surabaya' %}selected{% endif %}>Surabaya</option>
      <option value="Depok" {% if request.GET.location == 'Depok' %}selected{% endif %}>Depok</option>
      <option value="Tangerang" {% if request.GET.location == 'Tangerang' %}selected{% endif %}>Tangerang</option>
      <option value="Bekasi" {% if request.GET.location == 'Bekasi' %}selected{% endif %}>Bekasi</option>
    </select>

    <input type="hidden" name="min_price" id="min_price" value="{{ request.GET.min_price }}">
    <input type="hidden" name="max_price" id="max_price" value="{{ request.GET.max_price }}">

    <button type="button" id="btn-price" class="btn-outline" style="white-space:nowrap;">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="12" y1="1" x2="12" y2="23"></line>
        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
      </svg>
      <span>Price</span>
    </button>

    <button type="submit" class="btn-primary" style="white-space:nowrap;">
      üîç Search
    </button>
  </div>

  <!-- Price Modal -->
  <dialog id="price-modal" class="mb-modal">
    <div class="mb-modal-body">
      <h3>Filter Harga</h3>
      <div class="mb-field">
        <span>Harga Minimum (Rp)</span>
        <input type="text" id="price_min_field" placeholder="0">
      </div>
      <div class="mb-field">
        <span>Harga Maksimum (Rp)</span>
        <input type="text" id="price_max_field" placeholder="Tidak terbatas">
      </div>
      <div class="mb-actions">
        <button type="button" id="price-clear" class="btn-secondary-modal">Bersihkan</button>
        <button type="button" id="price-cancel" class="btn-secondary-modal">Batal</button>
        <button type="button" id="price-apply" class="btn-primary">Terapkan</button>
      </div>
    </div>
  </dialog>

  <!-- Category Pills - UPDATED: Same as Court categories -->
  <div style="display:flex; gap:8px; margin-top:16px; flex-wrap:wrap;">
    <button type="button" class="category-pill {% if not request.GET.category %}active{% endif %}" onclick="setCategory('')">All</button>
    <button type="button" class="category-pill {% if request.GET.category == 'badminton' %}active{% endif %}" onclick="setCategory('badminton')">Badminton</button>
    <button type="button" class="category-pill {% if request.GET.category == 'basketball' %}active{% endif %}" onclick="setCategory('basketball')">Basketball</button>
    <button type="button" class="category-pill {% if request.GET.category == 'soccer' %}active{% endif %}" onclick="setCategory('soccer')">Soccer</button>
    <button type="button" class="category-pill {% if request.GET.category == 'tennis' %}active{% endif %}" onclick="setCategory('tennis')">Tennis</button>
    <button type="button" class="category-pill {% if request.GET.category == 'volleyball' %}active{% endif %}" onclick="setCategory('volleyball')">Volleyball</button>
    <button type="button" class="category-pill {% if request.GET.category == 'paddle' %}active{% endif %}" onclick="setCategory('paddle')">Paddle</button>
    <button type="button" class="category-pill {% if request.GET.category == 'futsal' %}active{% endif %}" onclick="setCategory('futsal')">Futsal</button>
    <button type="button" class="category-pill {% if request.GET.category == 'table_tennis' %}active{% endif %}" onclick="setCategory('table_tennis')">Table Tennis</button>
  </div>
  <input type="hidden" name="category" id="category-input" value="{{ request.GET.category }}">

  <!-- Available coaches checkbox + Add Coach button -->
  <div class="filter-footer">
    <div class="filter-left">
      <label class="avail-check">
        <input type="checkbox" name="available" value="1" {% if request.GET.available %}checked{% endif %}>
        Show only available coaches
      </label>
    </div>
    <a href="{% url 'coach:create_coach_page' %}" class="btn-add">+ Add Coach</a>
  </div>
</form>

<!-- View Mode -->
<div class="view-mode-container">
  <div class="view-mode-group">
    <button type="button" class="view-mode-btn {% if view_mode == 'all' or not view_mode %}active{% endif %}" onclick="changeViewMode('all')">All</button>
    <button type="button" class="view-mode-btn {% if view_mode == 'my_bookings' %}active{% endif %}" onclick="changeViewMode('my_bookings')">My Bookings</button>
    <button type="button" class="view-mode-btn {% if view_mode == 'my_coaches' %}active{% endif %}" onclick="changeViewMode('my_coaches')">My Coaches</button>
  </div>
</div>

<!-- Meta Info -->
<div class="meta-wrap">
  <div class="meta-left">Menampilkan {{ count }} coach</div>
  <div class="meta-right">
    <label class="sort-inline">
      <span>Urutkan berdasarkan :</span>
      <select name="sort" form="filter-form" onchange="document.getElementById('filter-form').submit()">
        <option value="date_asc" {% if request.GET.sort == 'date_asc' or not request.GET.sort %}selected{% endif %}>Waktu dan Tanggal</option>
        <option value="date_desc" {% if request.GET.sort == 'date_desc' %}selected{% endif %}>Tanggal Terbaru</option>
        <option value="price_asc" {% if request.GET.sort == 'price_asc' %}selected{% endif %}>Harga Terendah</option>
        <option value="price_desc" {% if request.GET.sort == 'price_desc' %}selected{% endif %}>Harga Tertinggi</option>
      </select>
    </label>
  </div>
</div>

<!-- Coach Cards -->
<div class="cards">
  {% if coach_list %}
    {% for c in coach_list %}
      <div class="coach-card" onclick="window.location.href='{% url 'coach:coach_detail' c.pk %}'">
        <!-- Thumbnail -->
        <div class="coach-thumb">
          {% if c.image %}
            <img src="{{ c.image.url }}" alt="{{ c.title }}">
          {% else %}
            <div style="width:100%; height:100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display:flex; align-items:center; justify-content:center; color:#fff; font-size:2rem; font-weight:700;">
              {{ c.category|upper|slice:":1" }}
            </div>
          {% endif %}
        </div>

        <!-- Content -->
        <div class="coach-card-content">
          <!-- Status Badge -->
          <span class="coach-status-badge-inline {% if not c.isBooked %}available{% else %}booked{% endif %}">
            {% if not c.isBooked %}Tersedia{% else %}Booked{% endif %}
          </span>
          
          <!-- Title -->
          <h3>{{ c.title }}</h3>
          
          <!-- Info -->
          <div class="coach-info">
            <div class="coach-info-item">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 4.14 2.71 2.71 4.14l1.43 1.43L2 7.71l1.43 1.43L2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22l1.43-1.43L16.29 22l2.14-2.14 1.43 1.43 1.43-1.43-1.43-1.43L22 16.29z"/>
              </svg>
              <span>Jenis olahraga: {{ c.category|title }}</span>
            </div>

            <div class="coach-info-item">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="m9.69 18.933.003.001C9.89 19.02 10 19 10 19s.11.02.308-.066l.002-.001.006-.003.018-.008a5.741 5.741 0 0 0 .281-.14c.186-.096.446-.24.757-.433.62-.384 1.445-.966 2.274-1.765C15.302 14.988 17 12.493 17 9A7 7 0 1 0 3 9c0 3.492 1.698 5.988 3.355 7.584a13.731 13.731 0 0 0 2.273 1.765 11.842 11.842 0 0 0 .976.544l.062.029.018.008.006.003ZM10 11.25a2.25 2.25 0 1 0 0-4.5 2.25 2.25 0 0 0 0 4.5Z" clip-rule="evenodd"/>
              </svg>
              <span>Lokasi: {{ c.location }}</span>
            </div>
            <div class="coach-info-item">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path d="M5.25 12a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75H6a.75.75 0 0 1-.75-.75V12ZM6 13.25a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75V14a.75.75 0 0 0-.75-.75H6ZM7.25 12a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75H8a.75.75 0 0 1-.75-.75V12ZM8 13.25a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75V14a.75.75 0 0 0-.75-.75H8ZM9.25 10a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75H10a.75.75 0 0 1-.75-.75V10ZM10 11.25a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75V12a.75.75 0 0 0-.75-.75H10ZM9.25 14a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75H10a.75.75 0 0 1-.75-.75V14ZM12 9.25a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75V10a.75.75 0 0 0-.75-.75H12ZM11.25 12a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75H12a.75.75 0 0 1-.75-.75V12ZM12 13.25a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75V14a.75.75 0 0 0-.75-.75H12ZM13.25 10a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75H14a.75.75 0 0 1-.75-.75V10ZM14 11.25a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75V12a.75.75 0 0 0-.75-.75H14Z"/>
                <path fill-rule="evenodd" d="M5.75 2a.75.75 0 0 1 .75.75V4h7V2.75a.75.75 0 0 1 1.5 0V4h.25A2.75 2.75 0 0 1 18 6.75v8.5A2.75 2.75 0 0 1 15.25 18H4.75A2.75 2.75 0 0 1 2 15.25v-8.5A2.75 2.75 0 0 1 4.75 4H5V2.75A.75.75 0 0 1 5.75 2Zm-1 5.5c-.69 0-1.25.56-1.25 1.25v6.5c0 .69.56 1.25 1.25 1.25h10.5c.69 0 1.25-.56 1.25-1.25v-6.5c0-.69-.56-1.25-1.25-1.25H4.75Z" clip-rule="evenodd"/>
              </svg>
              <span>{{ c.date|date:"d M Y" }}</span>
            </div>
            <div class="coach-info-item">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm.75-13a.75.75 0 0 0-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 0 0 0-1.5h-3.25V5Z" clip-rule="evenodd"/>
              </svg>
              <span>{{ c.startTime|time:"H:i" }} - {{ c.endTime|time:"H:i" }}</span>
            </div>
            <div class="coach-info-item">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path d="M10 9a3 3 0 1 0 0-6 3 3 0 0 0 0 6ZM6 8a2 2 0 1 1-4 0 2 2 0 0 1 4 0ZM1.49 15.326a.78.78 0 0 1-.358-.442 3 3 0 0 1 4.308-3.516 6.484 6.484 0 0 0-1.905 3.959c-.023.222-.014.442.025.654a4.97 4.97 0 0 1-2.07-.655ZM16.44 15.98a4.97 4.97 0 0 0 2.07-.654.78.78 0 0 0 .357-.442 3 3 0 0 0-4.308-3.517 6.484 6.484 0 0 1 1.907 3.96 2.32 2.32 0 0 1-.026.654ZM18 8a2 2 0 1 1-4 0 2 2 0 0 1 4 0ZM5.304 16.19a.844.844 0 0 1-.277-.71 5 5 0 0 1 9.947 0 .843.843 0 0 1-.277.71A6.975 6.975 0 0 1 10 18a6.974 6.974 0 0 1-4.696-1.81Z"/>
              </svg>
              <span>{{ c.user.nama }}</span>
            </div>
          </div>

          <!-- Price  -->
          <div class="coach-price">
            {{ c.price_formatted }} <small>/sesi</small>
          </div>

          <!-- Action Buttons -->
          <div class="coach-card-actions" onclick="event.stopPropagation();">
            {% if user and user.id and c.user_id == user.id %}
              <a href="{% url 'coach:edit_coach_page' c.pk %}" class="btn-edit-card">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                  <path d="m5.433 13.917 1.262-3.155A4 4 0 0 1 7.58 9.42l6.92-6.918a2.121 2.121 0 0 1 3 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 0 1-.65-.65Z"/>
                  <path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0 0 10 3H4.75A2.75 2.75 0 0 0 2 5.75v9.5A2.75 2.75 0 0 0 4.75 18h9.5A2.75 2.75 0 0 0 17 15.25V10a.75.75 0 0 0-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5Z"/>
                </svg>
                Edit
              </a>
            {% endif %}
            <button type="button" class="btn-detail-booking" onclick="window.location.href='{% url 'coach:coach_detail' c.pk %}'">
              Lihat Detail & Booking
            </button>
          </div>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="empty-state">
      <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
        <circle cx="12" cy="7" r="4"></circle>
        <line x1="23" y1="21" x2="1" y2="21"></line>
      </svg>
      <h3>No Coaches Found</h3>
      <p>{% if request.GET %}Try adjusting your search filters{% else %}Be the first to add a coach!{% endif %}</p>
      <a href="{% url 'coach:create_coach_page' %}" class="btn-add-empty">+ Add First Coach</a>
    </div>
  {% endif %}
</div>

</div>
</div>

<script>
// ==================== UTILITY FUNCTIONS ====================
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// ==================== CATEGORY FILTER ====================
function setCategory(cat) {
  document.getElementById('category-input').value = cat;
  document.getElementById('filter-form').submit();
}

// ==================== LOADING & ERROR HANDLING ====================
function showLoading() {
  document.getElementById('loadingOverlay').style.display = 'flex';
}

function hideLoading() {
  document.getElementById('loadingOverlay').style.display = 'none';
}

function showError(message) {
  document.getElementById('errorText').textContent = message;
  document.getElementById('errorMessage').style.display = 'block';
  setTimeout(() => hideError(), 5000);
}

function hideError() {
  document.getElementById('errorMessage').style.display = 'none';
}

// ==================== VIEW MODE ====================
function changeViewMode(mode) {
  const url = new URL(window.location);
  url.searchParams.set('view', mode);
  window.location.href = url.toString();
}

// ==================== FORM SUBMISSION HANDLING ====================
document.getElementById('filter-form').addEventListener('submit', function() {
  showLoading();
});

window.addEventListener('load', function() {
  hideLoading();
});

// ==================== GLOBAL ERROR HANDLER ====================
window.addEventListener('error', function(e) {
  hideLoading();
  showError('Something went wrong. Please refresh the page.');
});

// ==================== PRICE MODAL ====================
(function () {
  const form = document.querySelector('.search-bar');
  const dlg = document.getElementById('price-modal');
  const btnOpen = document.getElementById('btn-price');
  const btnApply = document.getElementById('price-apply');
  const btnCancel = document.getElementById('price-cancel');
  const btnClear = document.getElementById('price-clear');
  const minHidden = document.getElementById('min_price');
  const maxHidden = document.getElementById('max_price');
  const minField = document.getElementById('price_min_field');
  const maxField = document.getElementById('price_max_field');
  const labelSpan = btnOpen.querySelector('span');

  function onlyDigits(s){ return (s || '').replace(/[^\d]/g,''); }
  function fmtIDR(n){
    if(!n) return '';
    return 'Rp ' + String(n).replace(/\B(?=(\d{3})+(?!\d))/g, '.');
  }
  function updateButtonLabel(){
    const a = onlyDigits(minHidden.value);
    const b = onlyDigits(maxHidden.value);
    if (a || b) {
      labelSpan.textContent = `${fmtIDR(a || 0)} ‚Äì ${fmtIDR(b || '') || '‚àû'}`;
    } else {
      labelSpan.textContent = 'Price';
    }
  }

  btnOpen.addEventListener('click', () => {
    minField.value = minHidden.value || '';
    maxField.value = maxHidden.value || '';
    if (typeof dlg.showModal === 'function') dlg.showModal();
    else dlg.setAttribute('open',''); 
  });

  btnApply.addEventListener('click', () => {
    minHidden.value = onlyDigits(minField.value);
    maxHidden.value = onlyDigits(maxField.value);
    updateButtonLabel();
    dlg.close();
    form.submit();
  });

  btnClear.addEventListener('click', () => {
    minHidden.value = '';
    maxHidden.value = '';
    minField.value = '';
    maxField.value = '';
    updateButtonLabel();
    dlg.close();
    form.submit();
  });

  btnCancel.addEventListener('click', () => dlg.close());

  updateButtonLabel();
})();
</script>
{% endblock content %}
