{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>MoveBuddy - Search Your Coach</title>
<link rel="stylesheet" href="{% static 'coach/main.css' %}">
{% endblock meta %}

{% block content %}
<header>
  <h1>MoveBuddy</h1>
  <p>Find nearby sports coaches and book instantly.</p>
  <a href="{% url 'Auth_Profile:logout' %}">Logout</a>
</header>

<div class="container">

<form id="filter-form" class="search-bar" method="get" action="{% url 'coach:show_main' %}">

  <input type="text" 
         name="nama_coach" 
         placeholder="Cari pelatih (nama)"
         value="{{ nama_coach|default:'' }}">

  <select name="location">
    <option value="">Semua Lokasi</option>
    <option value="Jakarta" {% if request.GET.location == 'Jakarta' %}selected{% endif %}>Jakarta</option>
    <option value="Bandung" {% if request.GET.location == 'Bandung' %}selected{% endif %}>Bandung</option>
    <option value="Surabaya"  {% if request.GET.location == 'Surabaya' %}selected{% endif %}>Surabaya</option>
    <option value="Depok"     {% if request.GET.location == 'Depok' %}selected{% endif %}>Depok</option>
    <option value="Tangerang" {% if request.GET.location == 'Tangerang' %}selected{% endif %}>Tangerang</option>
    <option value="Bekasi"    {% if request.GET.location == 'Bekasi' %}selected{% endif %}>Bekasi</option>
  </select>

  <select name="category">
    <option value="">Semua kategori</option>
    <option value="tennis"       {% if request.GET.category == 'tennis' %}selected{% endif %}>Tennis</option>
    <option value="basketball"   {% if request.GET.category == 'basketball' %}selected{% endif %}>Basketball</option>
    <option value="soccer"       {% if request.GET.category == 'soccer' %}selected{% endif %}>Soccer</option>
    <option value="badminton"    {% if request.GET.category == 'badminton' %}selected{% endif %}>Badminton</option>
    <option value="volleyball"   {% if request.GET.category == 'volleyball' %}selected{% endif %}>Volleyball</option>
    <option value="paddle"       {% if request.GET.category == 'paddle' %}selected{% endif %}>Paddle</option>
    <option value="futsal"       {% if request.GET.category == 'futsal' %}selected{% endif %}>Futsal</option>
    <option value="table_tennis" {% if request.GET.category == 'table_tennis' %}selected{% endif %}>Table Tennis</option>
    <option value="swimming"     {% if request.GET.category == 'swimming' %}selected{% endif %}>Swimming</option>
  </select>

  <input type="hidden" id="min_price" name="min_price" value="{{ request.GET.min_price }}">
  <input type="hidden" id="max_price" name="max_price" value="{{ request.GET.max_price }}">
  <input type="hidden" name="view" value="{{ view_mode }}">  {# NEW: hidden input untuk view mode #}
  
  <div class="price-group">
    <button type="button" id="btn-price" class="btn-outline">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
  <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"></path>
  <path d="M3 5v14a2 2 0 0 0 2 2h16v-5"></path>
  <path d="M18 12a2 2 0 0 0 0 4h4v-4Z"></path>
</svg>
      <span>Harga</span>
    </button>
    <button type="submit" class="btn-primary">Terapkan</button>
  </div>


  <!-- Modal Harga -->
<dialog id="price-modal" class="mb-modal">
  <div class="mb-modal-body">
    <h3>Filter Harga</h3>
    
    <div class="mb-field">
      <span>Harga Minimum (Rp)</span>
      <input type="text" id="price_min_field" placeholder="0">
    </div>
    
    <div class="mb-field">
      <span>Harga Maksimum (Rp)</span>
      <input type="text" id="price_max_field" placeholder="Tidak terbatas">
    </div>
    
    <div class="mb-actions">
      <button type="button" id="price-clear" class="btn-secondary-modal">Bersihkan</button>
      <button type="button" id="price-cancel" class="btn-secondary-modal">Batal</button>
      <button type="button" id="price-apply" class="btn-primary">Terapkan</button>
    </div>
  </div>
</dialog>

  <div class="filter-footer">
    <div class="filter-left">
      <label class="avail-check">
        <input type="checkbox" name="available" value="1"
               {% if request.GET.available %}checked{% endif %}>
        Show only available coaches
      </label>
    </div>
    <a href="{% url 'coach:create_coach_page' %}" class="btn-add">+ Add Coach</a>
  </div>
</form>

<div class="view-mode-container">
  <div class="view-mode-group">
    <button type="button" 
            class="view-mode-btn {% if view_mode == 'all' or not view_mode %}active{% endif %}"
            onclick="changeViewMode('all')">
      All
    </button>
    <button type="button" 
            class="view-mode-btn {% if view_mode == 'my_bookings' %}active{% endif %}"
            onclick="changeViewMode('my_bookings')">
      My Bookings
    </button>
    <button type="button" 
            class="view-mode-btn {% if view_mode == 'my_coaches' %}active{% endif %}"
            onclick="changeViewMode('my_coaches')">
      My Coaches
    </button>
  </div>
</div>

<div class="meta-wrap">
  <div class="meta-left">Menampilkan {{ count }} coach</div>
  <div class="meta-right">
    <label class="sort-inline">
      <span>Urutkan berdasarkan :</span>
      <select name="sort" form="filter-form"
              onchange="document.getElementById('filter-form').submit()">
        <option value="date_asc"   {% if request.GET.sort == 'date_asc' or not request.GET.sort %}selected{% endif %}>Waktu dan Tanggal</option>
        <option value="price_asc"  {% if request.GET.sort == 'price_asc' %}selected{% endif %}>Harga Terendah</option>
        <option value="price_desc" {% if request.GET.sort == 'price_desc' %}selected{% endif %}>Harga Tertinggi</option>
      </select>
    </label>
  </div>
</div>
  <div class="cards">
    {% for c in coach_list %}
      <article class="coach-card">
        <a href="{% url 'coach:coach_detail' c.pk %}" class="card-link">
          <div class="coach-thumb">
            {% if c.image %}
              <img src="{{ c.image.url }}" alt="{{ c.title }}">
            {% else %}
              <div style="width:100%; height:100%; background:#f0f0f0; display:flex; align-items:center; justify-content:center; color:#999;">
                {{ c.category|upper }}
              </div>
            {% endif %}
            
            <!-- Ribbon untuk card -->
            {% if c.isBooked %}
            <div class="ribbon-wrapper-small">
              <div class="ribbon-small">BOOKED</div>
            </div>
            {% endif %}
          </div>
          
          <div class="coach-card-content">
            <span class="coach-badge">{{ c.category|title }}</span>
            <h3>{{ c.title }}</h3>

            <div class="coach-info">
              <span>ğŸ“ {{ c.location }}</span>
              {% if c.address %}<span>ğŸ“Œ {{ c.address }}</span>{% endif %}
              <span>ğŸ“… {{ c.date|date:"d M Y" }}</span>
              <span>ğŸ• {{ c.startTime|time:"H:i" }} - {{ c.endTime|time:"H:i" }}</span>
              <span>â­ {{ c.rating }}</span>
              <span>ğŸ‘¤ {{ c.user.nama }}</span>
            </div>

            <div class="coach-price">{{ c.price_formatted }} <small>/sesi</small></div>
          </div>
        </a>

        {% if request.user.is_authenticated and c.user_id == request.user.id %}
          <a class="btn-edit-small" href="{% url 'coach:edit_coach_page' c.pk %}" onclick="event.stopPropagation()">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
            Edit
          </a>
        {% endif %}
      </article>
    {% empty %}
      <div class="no-results">
        <h3>Belum ada coach</h3>
        <p>Tambahkan coach pertama Anda.</p>
      </div>
    {% endfor %}
  </div>
</div>
<script>

function changeViewMode(mode) {
  const form = document.getElementById('filter-form');
  
  // Remove existing view input if any
  const existingInput = form.querySelector('input[name="view"]');
  if (existingInput) {
    existingInput.remove();
  }
  
  const input = document.createElement('input');
  input.type = 'hidden';
  input.name = 'view';
  input.value = mode;
  form.appendChild(input);
  
  // Submit form
  form.submit();
}

(function () {
  const form        = document.querySelector('.search-bar');
  const dlg         = document.getElementById('price-modal');
  const btnOpen     = document.getElementById('btn-price');
  const btnApply    = document.getElementById('price-apply');
  const btnCancel   = document.getElementById('price-cancel');
  const btnClear    = document.getElementById('price-clear');

  const minHidden   = document.getElementById('min_price');
  const maxHidden   = document.getElementById('max_price');
  const minField    = document.getElementById('price_min_field');
  const maxField    = document.getElementById('price_max_field');

  const labelSpan   = btnOpen.querySelector('span');

  function onlyDigits(s){ return (s || '').replace(/[^\d]/g,''); }
  function fmtIDR(n){
    if(!n) return '';
    return 'Rp ' + String(n).replace(/\B(?=(\d{3})+(?!\d))/g, '.');
  }
  function updateButtonLabel(){
    const a = onlyDigits(minHidden.value);
    const b = onlyDigits(maxHidden.value);
    if (a || b) {
      labelSpan.textContent = `${fmtIDR(a || 0)} â€“ ${fmtIDR(b || '') || 'âˆ'}`;
    } else {
      labelSpan.textContent = 'Harga';
    }
  }

  btnOpen.addEventListener('click', () => {
    minField.value = minHidden.value || '';
    maxField.value = maxHidden.value || '';
    if (typeof dlg.showModal === 'function') dlg.showModal();
    else dlg.setAttribute('open',''); 
  });


  btnApply.addEventListener('click', () => {
    minHidden.value = onlyDigits(minField.value);
    maxHidden.value = onlyDigits(maxField.value);
    updateButtonLabel();
    dlg.close();
    form.submit();
  });

  btnClear.addEventListener('click', () => {
    minHidden.value = '';
    maxHidden.value = '';
    minField.value = '';
    maxField.value = '';
    updateButtonLabel();
    dlg.close();
    form.submit();
  });


  btnCancel.addEventListener('click', () => dlg.close());


  updateButtonLabel();
})();
</script>
{% endblock content %}
