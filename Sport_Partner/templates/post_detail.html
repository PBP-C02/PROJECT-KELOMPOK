{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>{{ post.title }} - MoveBuddy Post Detail</title>
<style>
    .bg-detail-main {
        background-image: url('{% static "img/bg.png" %}');
        background-size: cover;
        background-position: center;
    }
</style>
{% endblock meta %}

{% block content %}
<section class="relative min-h-screen overflow-hidden py-12">
  <div class="bg-detail-main absolute inset-0 bg-cover bg-center"></div>
  <div class="absolute inset-0 bg-white/95"></div>

  <div class="relative z-10">
    {% include 'includes/navbar.html' %}
    <div class="mx-auto w-full max-w-7xl space-y-6 px-5 sm:px-10">
      <a href="{% url 'Sport_Partner:show_post' %}" class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white/90 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-slate-600 transition hover:-translate-y-0.5 hover:border-slate-300 hover:text-slate-900">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m15 19-7-7 7-7" />
        </svg>
        Back to Posts
      </a>

      <article class="overflow-hidden rounded-[2.5rem] bg-white/95 shadow-[0_32px_80px_rgba(15,23,42,0.12)] backdrop-blur">
        <div class="grid gap-8 px-6 py-8 md:px-10 md:py-10 lg:grid-cols-[1.6fr_1fr]">
          <div class="space-y-8">
            <header class="space-y-4">
              <div class="flex flex-wrap items-center gap-3">
                <span class="inline-flex items-center justify-center rounded-full border border-lime-200 bg-lime-100 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-lime-700">
                  {{ post.get_category_display }}
                </span>
              </div>

              <div>
                <h1 class="text-3xl font-bold uppercase tracking-[0.22em] text-slate-900 md:text-4xl">{{ post.title }}</h1>
                <p class="mt-2 flex items-center gap-2 text-sm font-semibold uppercase tracking-[0.28em] text-slate-500">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.5 20.118a7.5 7.5 0 0 1 15 0A17.933 17.933 0 0 1 12 21.75c-2.68 0-5.216-.584-7.5-1.632Z" />
                  </svg>
                  {{ post.creator.nama }}
                </p>
              </div>
            </header>

            {% if post.description %}
            <section class="space-y-3">
              <h2 class="text-sm font-semibold uppercase tracking-[0.28em] text-slate-600">Description</h2>
              <div class="rounded-2xl border border-slate-200 bg-slate-50/80 p-5 text-sm leading-relaxed text-slate-600">
                {{ post.description }}
              </div>
            </section>
            {% endif %}

            <div class="grid gap-6 md:grid-cols-2">
              <section class="space-y-3">
                <h2 class="text-sm font-semibold uppercase tracking-[0.28em] text-slate-600">Date & Time</h2>
                <div class="space-y-3 rounded-2xl border border-slate-200 bg-slate-50/80 p-5">
                  <div class="flex items-center gap-3 text-sm text-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-lime-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" />
                    </svg>
                    <span class="font-semibold">{{ post.tanggal }}</span>
                  </div>
                  <div class="flex items-center gap-3 text-sm text-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-lime-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                    <span class="font-semibold">{{ post.jam_mulai }} - {{ post.jam_selesai }}</span>
                  </div>
                </div>
              </section>

              <section class="space-y-3">
                <h2 class="text-sm font-semibold uppercase tracking-[0.28em] text-slate-600">Location</h2>
                <div class="rounded-2xl border border-slate-200 bg-slate-50/80 p-5">
                  <div class="flex items-start gap-3 text-sm text-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-rose-500 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
                    </svg>
                    <span class="font-semibold">{{ post.lokasi }}</span>
                  </div>
                </div>
              </section>
            </div>

            <section class="space-y-4">
              <h2 class="text-sm font-semibold uppercase tracking-[0.28em] text-slate-600">
                Participants (<span id="participant-count">0</span>)
              </h2>

              <div id="loading" class="hidden rounded-2xl border border-slate-200 bg-slate-50/80 p-5 text-center text-sm text-slate-500">
                <svg class="mx-auto h-8 w-8 animate-spin text-lime-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2">Loading participants...</p>
              </div>

              <div id="error-message" class="hidden rounded-2xl border border-rose-200 bg-rose-50 p-4 text-sm text-rose-700"></div>

              <div class="rounded-2xl border border-slate-200 bg-slate-50/80 p-5">
                <div id="participant-list" class="space-y-2 max-h-[400px] overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-slate-300 scrollbar-track-slate-100"></div>
              </div>
            </section>
          </div>

          <aside class="space-y-6">
            <div class="rounded-3xl border border-slate-200 bg-white/95 p-6 shadow-[0_18px_40px_rgba(15,23,42,0.06)] space-y-5">
              <div class="flex items-center gap-3 rounded-2xl border border-slate-200 bg-slate-50 px-5 py-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-sky-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.5 20.118a7.5 7.5 0 0 1 15 0A17.933 17.933 0 0 1 12 21.75c-2.68 0-5.216-.584-7.5-1.632Z" />
                </svg>
                <div>
                  <p class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">Created by</p>
                  <p class="text-sm font-semibold text-slate-800">{{ post.creator.nama }}</p>
                </div>
              </div>

              <div id="action-section" class="space-y-3">
                {% if post.creator.id != user_now.id %}
                  {% if is_participant %}
                    <button id="leave-btn" onclick="leavePost()" class="w-full rounded-2xl border border-rose-300 bg-rose-50 px-6 py-3 text-sm font-semibold uppercase tracking-[0.3em] text-rose-700 transition hover:-translate-y-0.5 hover:bg-rose-100">
                      Leave Activity
                    </button>
                  {% else %}
                    <button id="join-btn" onclick="joinPost()" class="w-full rounded-2xl bg-lime-500 px-6 py-3 text-sm font-semibold uppercase tracking-[0.3em] text-white transition hover:-translate-y-0.5 hover:bg-lime-600">
                      Join Now!
                    </button>
                  {% endif %}
                {% else %}
                  <div class="rounded-2xl border border-sky-200 bg-sky-50 px-5 py-4 text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-8 w-8 text-sky-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                    <p class="mt-2 text-sm font-semibold text-sky-700">You are the creator of this post</p>
                  </div>
                {% endif %}
              </div>
            </div>
          </aside>
        </div>
      </article>
    </div>
  </div>
</section>

<script>
const POST_ID = '{{ post.post_id }}';
const CSRF_TOKEN = '{{ csrf_token }}';

// Load participants
async function loadParticipants() {
    const loading = document.getElementById('loading');
    const errorDiv = document.getElementById('error-message');
    const participantList = document.getElementById('participant-list');
    const participantCount = document.getElementById('participant-count');
    
    loading.classList.remove('hidden');
    errorDiv.classList.add('hidden');
    errorDiv.textContent = '';
    
    try {
        const response = await fetch(`/sport_partner/post/${POST_ID}/participants/`);
        const data = await response.json();
        
        if (data.success) {
            participantList.innerHTML = '';
            participantCount.textContent = data.total;
            
            if (data.participants.length === 0) {
                participantList.innerHTML = '<p class="text-center text-sm text-slate-400">Belum ada participant</p>';
            } else {
                data.participants.forEach(participant => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-3 rounded-xl border border-slate-200 bg-white px-4 py-3 shadow-sm';
                    div.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.5 20.118a7.5 7.5 0 0 1 15 0A17.933 17.933 0 0 1 12 21.75c-2.68 0-5.216-.584-7.5-1.632Z" />
                        </svg>
                        <div class="flex-1">
                            <p class="text-sm font-semibold text-slate-800">${participant.nama}</p>
                            <p class="text-xs text-slate-500">${participant.email}</p>
                        </div>
                    `;
                    participantList.appendChild(div);
                });
            }
        } else {
            errorDiv.textContent = 'Gagal memuat participants';
            errorDiv.classList.remove('hidden');
        }
    } catch (error) {
        errorDiv.textContent = 'Terjadi kesalahan saat memuat participants';
        errorDiv.classList.remove('hidden');
        console.error(error);
    } finally {
        loading.classList.add('hidden');
    }
}

// Join post
async function joinPost() {
    const errorDiv = document.getElementById('error-message');
    errorDiv.classList.add('hidden');
    errorDiv.textContent = '';
    
    try {
        const response = await fetch(`/sport_partner/post/${POST_ID}/join/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': CSRF_TOKEN,
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            errorDiv.textContent = data.message;
            errorDiv.classList.remove('hidden');
        }
    } catch (error) {
        errorDiv.textContent = 'Terjadi kesalahan';
        errorDiv.classList.remove('hidden');
        console.error(error);
    }
}

// Leave post
async function leavePost() {
    if (!confirm('Yakin ingin leave?')) return;
    
    const errorDiv = document.getElementById('error-message');
    errorDiv.classList.add('hidden');
    errorDiv.textContent = '';
    
    try {
        const response = await fetch(`/sport_partner/post/${POST_ID}/leave/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': CSRF_TOKEN,
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            errorDiv.textContent = data.message;
            errorDiv.classList.remove('hidden');
        }
    } catch (error) {
        errorDiv.textContent = 'Terjadi kesalahan';
        errorDiv.classList.remove('hidden');
        console.error(error);
    }
}

// Load participants on page load
loadParticipants();
</script>

{% endblock content %}
