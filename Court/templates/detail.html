{% extends 'base.html' %}
{% load static %}
{% block meta %}
<title>{{ court.name }} - MoveBuddy Court Detail</title>
<style>
    .bg-detail-main {
        background-image: url('{% static "img/bg.png" %}');
        background-size: cover;
        background-position: center;
    }
</style>
{% endblock meta %}

{% block content %}
<section class="relative min-h-screen overflow-hidden py-12">
  <div class="bg-detail-main absolute inset-0 bg-cover bg-center"></div>
  <div class="absolute inset-0 bg-white/95"></div>

  <div class="relative z-10">
    {% include 'includes/navbar.html' %}
    <div class="mx-auto w-full max-w-7xl space-y-6 px-5 sm:px-10">
      <a href="{% url 'Court:show_main' %}" class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white/90 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-slate-600 transition hover:-translate-y-0.5 hover:border-slate-300 hover:text-slate-900">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m15 19-7-7 7-7" />
        </svg>
        Back to Court List
      </a>

      <article class="overflow-hidden rounded-[2.5rem] bg-white/95 shadow-[0_32px_80px_rgba(15,23,42,0.12)] backdrop-blur">
        <div class="relative h-64 bg-gradient-to-br from-pink-500 to-rose-500">
          <img
            src="{% if court.image %}{{ court.image.url }}{% else %}data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20320%20200'%3E%3Cdefs%3E%3ClinearGradient%20id='a'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='100%25'%3E%3Cstop%20offset='0%25'%20stop-color='%23dbeafe'/%3E%3Cstop%20offset='60%25'%20stop-color='%23bfdbfe'/%3E%3Cstop%20offset='100%25'%20stop-color='%2393c5fd'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect%20width='320'%20height='200'%20fill='url(%23a)'/%3E%3Cg%20fill='none'%20stroke='%231e3a8a'%20stroke-width='6'%20opacity='0.35'%3E%3Crect%20x='30'%20y='40'%20width='260'%20height='120'%20rx='18'/%3E%3Cline%20x1='160'%20y1='40'%20x2='160'%20y2='160'/%3E%3Ccircle%20cx='160'%20cy='100'%20r='24'/%3E%3Ccircle%20cx='160'%20cy='100'%20r='8'/%3E%3C/g%3E%3C/svg%3E{% endif %}"
            alt="{{ court.name }}"
            class="h-full w-full object-cover"
            onerror="this.src='data:image/svg+xml,%3Csvg%20xmlns=\'http://www.w3.org/2000/svg\'%20viewBox=\'0%200%20320%20200\'%3E%3Cdefs%3E%3ClinearGradient%20id=\'a\'%20x1=\'0%25\'%20y1=\'0%25\'%20x2=\'100%25\'%20y2=\'100%25\'%3E%3Cstop%20offset=\'0%25\'%20stop-color=\'%23dbeafe\'/%3E%3Cstop%20offset=\'60%25\'%20stop-color=\'%23bfdbfe\'/%3E%3Cstop%20offset=\'100%25\'%20stop-color=\'%2393c5fd\'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect%20width=\'320\'%20height=\'200\'%20fill=\'url(%23a)\'/%3E%3Cg%20fill=\'none\'%20stroke=\'%231e3a8a\'%20stroke-width=\'6\'%20opacity=\'0.35\'%3E%3Crect%20x=\'30\'%20y=\'40\'%20width=\'260\'%20height=\'120\'%20rx=\'18\'/%3E%3Cline%20x1=\'160\'%20y1=\'40\'%20x2=\'160\'%20y2=\'160\'/%3E%3Ccircle%20cx=\'160\'%20cy=\'100\'%20r=\'24\'/%3E%3Ccircle%20cx=\'160\'%20cy=\'100\'%20r=\'8\'/%3E%3C/g%3E%3C/svg%3E';"
          />
        </div>

        <div class="grid gap-8 px-6 py-8 md:px-10 md:py-10 lg:grid-cols-[1.6fr_1fr]">
          <div class="space-y-8">
            <header class="space-y-4">
              <div class="flex flex-wrap items-center gap-3">
                <span class="inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] {% if court.is_available %}border-emerald-200 bg-emerald-100 text-emerald-700{% else %}border-rose-200 bg-rose-100 text-rose-700{% endif %}">
                  {% if court.is_available %}Available{% else %}Unavailable{% endif %}
                </span>
                <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white/80 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
                  <span id="detailRatingStars" class="inline-flex"></span>
                  <span class="text-slate-600">{{ court.rating|floatformat:1 }}/5.0</span>
                </span>
              </div>

              <div>
                <h1 class="text-3xl font-bold uppercase tracking-[0.22em] text-slate-900 md:text-4xl">{{ court.name }}</h1>
                <p class="mt-2 text-sm font-semibold uppercase tracking-[0.28em] text-slate-500">
                  {{ court.get_sport_type_display }} â€¢ {{ court.location }}
                </p>
              </div>
            </header>

            {% if court.description %}
            <section class="space-y-3">
              <h2 class="text-sm font-semibold uppercase tracking-[0.28em] text-slate-600">Description</h2>
              <div class="rounded-2xl border border-slate-200 bg-slate-50/80 p-5 text-sm leading-relaxed text-slate-600">
                {{ court.description }}
              </div>
            </section>
            {% endif %}

            <div class="grid gap-6 md:grid-cols-2">
              <section class="space-y-3">
                <h2 class="text-sm font-semibold uppercase tracking-[0.28em] text-slate-600">Address</h2>
                <div class="rounded-2xl border border-slate-200 bg-slate-50/80 p-5 text-sm text-slate-600">
                  {{ court.address }}
                </div>
              </section>
              <section class="space-y-3">
                <h2 class="text-sm font-semibold uppercase tracking-[0.28em] text-slate-600">Facilities</h2>
                <div class="flex flex-wrap gap-3 rounded-2xl border border-slate-200 bg-slate-50/80 p-5">
                  {% for facility in court.get_facilities_list %}
                  <span class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-600 shadow-inner">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-emerald-500" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M16.704 5.29a1 1 0 0 1 .005 1.414l-7.428 7.5a1 1 0 0 1-1.437-.01L3.29 9.414a1 1 0 1 1 1.42-1.406l3.12 3.152 6.714-6.78a1 1 0 0 1 1.414-.01Z" clip-rule="evenodd" />
                    </svg>
                    {{ facility }}
                  </span>
                  {% empty %}
                  <span class="text-sm text-slate-400">Belum ada fasilitas yang ditambahkan.</span>
                  {% endfor %}
                </div>
              </section>
            </div>
          </div>

          <aside class="space-y-6">
            <div class="rounded-3xl bg-gradient-to-br from-slate-900 to-slate-950 px-6 py-6 text-white shadow-lg">
              <span class="text-xs font-semibold uppercase tracking-[0.3em] text-white/70">Price per hour</span>
              <p class="mt-3 text-3xl font-bold tracking-[0.15em]">IDR {{ court.price_per_hour|floatformat:0 }}</p>
            </div>

            <div class="rounded-3xl border border-slate-200 bg-white/95 p-6 shadow-[0_18px_40px_rgba(15,23,42,0.06)] space-y-5">
              <div class="flex items-center gap-3 rounded-2xl border border-slate-200 bg-slate-50 px-5 py-3 text-sm font-semibold text-slate-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-sky-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.5 20.118a7.5 7.5 0 0 1 15 0A17.933 17.933 0 0 1 12 21.75c-2.68 0-5.216-.584-7.5-1.632Z" />
                </svg>
                <span>{{ court.owner_name }}</span>
              </div>

              <div class="flex flex-col gap-2">
                <label for="bookingDate" class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-600">Tanggal Reservasi</label>
                <input type="date" id="bookingDate" class="w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 shadow-inner outline-none transition focus:border-lime-300 focus:ring-4 focus:ring-lime-200/60" />
              </div>

              <div id="loadingSlots" class="hidden text-sm text-slate-500">
                Memuat ketersediaan...
              </div>

              <div class="space-y-4">
                <div id="availabilityStatus" class="flex items-center gap-3 rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm font-semibold text-slate-600 transition-colors">
                  Memeriksa ketersediaan...
                </div>

                {% if can_manage_slots %}
                <div class="flex flex-wrap gap-2">
                  <button type="button" id="markAvailable" class="flex items-center justify-center rounded-xl border border-emerald-300 bg-emerald-50 px-3 py-2 text-xs font-semibold text-emerald-700 transition hover:-translate-y-0.5 hover:shadow-lg hover:shadow-emerald-200/40 disabled:cursor-not-allowed disabled:opacity-60 min-w-[130px]" onclick="setAvailability(true)">
                    Tandai Tersedia
                  </button>
                  <button type="button" id="markUnavailable" class="flex items-center justify-center rounded-xl border border-rose-300 bg-rose-50 px-3 py-2 text-xs font-semibold text-rose-700 transition hover:-translate-y-0.5 hover:shadow-lg hover:shadow-rose-200/40 disabled:cursor-not-allowed disabled:opacity-60 min-w-[130px]" onclick="setAvailability(false)">
                    Tidak Tersedia
                  </button>
                  <button type="button" class="flex items-center justify-center rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs font-semibold uppercase tracking-[0.25em] text-slate-700 transition hover:-translate-y-0.5 hover:border-slate-300 hover:text-slate-900" title="Edit court" onclick="window.location.href='{% url \'Court:edit_court\' court.id %}'">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M4 13.5V16h2.5L15.374 7.126 12.874 4.626 4 13.5Zm12.915-7.915a.997.997 0 0 0 0-1.414l-1.586-1.586a.999.999 0 0 0-1.414 0L12.586 3.5l3.5 3.5.829-.415Z"/></svg>
                  </button>
                  <button type="button" class="flex items-center justify-center rounded-lg border border-rose-300 bg-white px-3 py-2 text-xs font-semibold uppercase tracking-[0.25em] text-rose-600 transition hover:-translate-y-0.5 hover:bg-rose-50" title="Hapus court" onclick="openDeleteModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M6 7a1 1 0 0 1 1 1v7a1 1 0 1 1-2 0V8a1 1 0 0 1 1-1Zm4 0a1 1 0 0 1 1 1v7a1 1 0 1 1-2 0V8a1 1 0 0 1 1-1Zm5-4h-3.5l-1-1h-4l-1 1H2v2h16V3h-3Z"/><path d="M4 6h12v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6Z"/></svg>
                  </button>
                </div>
                {% endif %}

                <button id="btnWhatsApp" onclick="bookViaWhatsApp()" disabled class="w-full rounded-2xl bg-emerald-500 px-6 py-3 text-sm font-semibold uppercase tracking-[0.3em] text-white transition hover:-translate-y-0.5 hover:bg-emerald-600 disabled:cursor-not-allowed disabled:opacity-60">
                  Book via WhatsApp
                </button>
              </div>
            </div>
          </aside>
        </div>
      </article>
    </div>
  </div>
</section>
<div id="deleteModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/60 px-4">
  <div class="w-full max-w-md rounded-3xl bg-white p-6 shadow-xl">
    <h3 class="text-lg font-semibold text-slate-900">Hapus Lapangan?</h3>
    <p class="mt-2 text-sm text-slate-600">Tindakan ini tidak dapat dibatalkan. Data lapangan akan hilang secara permanen.</p>
    <div class="mt-6 flex flex-col gap-3 sm:flex-row">
      <button type="button" class="flex-1 rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm font-semibold text-slate-700 transition hover:border-slate-300 hover:text-slate-900" onclick="closeDeleteModal()">
        Batal
      </button>
      <button type="button" class="flex-1 rounded-2xl bg-rose-500 px-4 py-3 text-sm font-semibold text-white transition hover:bg-rose-600" onclick="confirmDeleteCourt()">
        Ya, hapus sekarang
      </button>
    </div>
  </div>
</div>
<script>
  const STAR_FULL_ICON =
    `<svg aria-hidden="true" class="h-4 w-4 text-amber-400" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034 1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292-2.8-2.034c-.783-.57-.38-1.81.588-1.81h3.461z"/></svg>`;
  const STAR_EMPTY_ICON =
    `<svg aria-hidden="true" class="h-4 w-4 text-slate-300" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034 1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292-2.8-2.034c-.783-.57-.38-1.81.588-1.81h3.461z"/></svg>`;

  function renderStars(rating) {
      const value = Math.max(0, Math.min(5, parseFloat(rating) || 0));
      const stars = [];
      for (let i = 1; i <= 5; i++) {
          stars.push(i <= value ? STAR_FULL_ICON : STAR_EMPTY_ICON);
      }
      return stars.join('');
  }

  const courtId =  "{{ court.id }}" ;
  const canManageInitial =  "{{ can_manage_slots|yesno:'true,false' }}";
  const btnWhatsApp = document.getElementById('btnWhatsApp');
  let selectedDate = null;
  let currentAvailability = true;

  window.onload = function() {
      setMinDate();
      const detailRatingContainer = document.getElementById('detailRatingStars');
      if (detailRatingContainer) {
          const detailRatingValue = parseFloat('{{ court.rating|floatformat:"2" }}') || 0;
          detailRatingContainer.innerHTML = renderStars(detailRatingValue);
      }
      const deleteModal = document.getElementById('deleteModal');
      if (deleteModal) {
          deleteModal.addEventListener('click', function(event) {
              if (event.target === deleteModal) {
                  closeDeleteModal();
              }
          });
      }
  };

  function authFetch(url, options) {
      return fetch(url, options).then(response => {
          if (response.status === 401) {
              window.location.href = '/login/';
              throw new Error('Unauthenticated');
          }
          return response;
      });
  }

  function setMinDate() {
      const today = new Date().toISOString().split('T')[0];
      const dateInput = document.getElementById('bookingDate');
      dateInput.min = today;
      dateInput.value = today;
      selectedDate = today;
      loadAvailability();
  }

  function loadAvailability() {
      const date = document.getElementById('bookingDate').value;
      if (!date) {
          return;
      }

      selectedDate = date;
      showLoading(true);
      if (btnWhatsApp) {
          btnWhatsApp.disabled = true;
      }

      authFetch(`/court/api/court/${courtId}/availability/?date=${encodeURIComponent(date)}`)
          .then(response => response.json())
          .then(data => {
              currentAvailability = data ? !!data.available : true;
              updateAvailabilityStatus(currentAvailability);
              updateManagementButtons(data && data.can_manage ? true : canManageInitial);
              showLoading(false);
          })
          .catch(error => {
              if (error && error.message === 'Unauthenticated') {
                  return;
              }
              console.error('Error:', error);
              showLoading(false);
              alert('Gagal memuat data ketersediaan.');
          });
  }

  function updateAvailabilityStatus(isAvailable) {
      const statusEl = document.getElementById('availabilityStatus');
      if (!statusEl) return;

      statusEl.classList.remove('text-emerald-700', 'border-emerald-200', 'bg-emerald-50', 'text-rose-700', 'border-rose-200', 'bg-rose-50');
      const dateLabel = formatDateForLabel(selectedDate);

      if (isAvailable) {
          statusEl.classList.add('text-emerald-700', 'border-emerald-200', 'bg-emerald-50');
          statusEl.innerHTML = `Lapangan tersedia pada ${dateLabel}.`;
          if (btnWhatsApp) {
              btnWhatsApp.disabled = false;
          }
      } else {
          statusEl.classList.add('text-rose-700', 'border-rose-200', 'bg-rose-50');
          statusEl.innerHTML = `Lapangan tidak tersedia pada ${dateLabel}.`;
          if (btnWhatsApp) {
              btnWhatsApp.disabled = true;
          }
      }
  }

  function updateManagementButtons(canManage) {
      const availableBtn = document.getElementById('markAvailable');
      const unavailableBtn = document.getElementById('markUnavailable');
      if (!availableBtn || !unavailableBtn) {
          return;
      }

      availableBtn.disabled = !canManage || currentAvailability;
      unavailableBtn.disabled = !canManage || !currentAvailability;
  }

  function setAvailability(isAvailable) {
      if (!selectedDate) {
          alert('Pilih tanggal terlebih dahulu.');
          return;
      }

      authFetch(`/court/api/court/${courtId}/availability/set/`, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({
              date: selectedDate,
              is_available: isAvailable
          })
      })
      .then(response => response.json())
      .then(data => {
          if (!data.success) {
              throw new Error(data.error || 'Gagal memperbarui ketersediaan.');
          }
          currentAvailability = data.available;
          updateAvailabilityStatus(currentAvailability);
          updateManagementButtons(true);
      })
      .catch(error => {
          if (error && error.message === 'Unauthenticated') {
              return;
          }
          console.error('Error:', error);
          alert('Gagal memperbarui ketersediaan.');
      });
  }

  function showLoading(isLoading) {
      const loadingEl = document.getElementById('loadingSlots');
      if (!loadingEl) return;
      loadingEl.classList.toggle('hidden', !isLoading);
  }

  function formatDateForLabel(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('id-ID', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
      });
  }

  function bookViaWhatsApp() {
      if (!selectedDate) {
          alert('Pilih tanggal terlebih dahulu.');
          return;
      }

      authFetch('/court/api/court/whatsapp/', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({
              court_id: "{{ court.id }}",
              date: selectedDate
          })
      })
      .then(response => response.json())
      .then(data => {
          const link = data.whatsapp_link || data.link;
          if (!data.success || !link) {
              throw new Error(data.error || 'Link WhatsApp tidak tersedia');
          }
          window.open(link, '_blank');
      })
      .catch(error => {
          if (error && error.message === 'Unauthenticated') {
              return;
          }
          console.error('Error:', error);
          alert('Gagal membuka WhatsApp.');
      });
  }

  function confirmDeleteCourt() {
      authFetch(`/court/api/court/${courtId}/delete/`, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken')
          }
      })
      .then(response => response.json())
      .then(data => {
          if (!data.success) {
              throw new Error(data.error || 'Gagal menghapus lapangan.');
          }
          closeDeleteModal();
          window.location.href = '{% url "Court:show_main" %}';
      })
      .catch(error => {
          if (error && error.message === 'Unauthenticated') {
              return;
          }
          console.error('Error:', error);
          alert('Gagal menghapus lapangan.');
      });
  }

  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }

  document.getElementById('bookingDate').addEventListener('change', loadAvailability);
  function openDeleteModal() {
      const modal = document.getElementById('deleteModal');
      if (modal) {
          modal.classList.add('flex');
          modal.classList.remove('hidden');
      }
  }
  
  function closeDeleteModal() {
      const modal = document.getElementById('deleteModal');
      if (modal) {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
      }
  }
</script>
{% endblock content %}
