{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Event - MoveBuddy</title>
    <link rel="stylesheet" href="{% static 'css/globals.css' %}">
    <link rel="stylesheet" href="{% static 'css/event.css' %}">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <!-- Include Navbar -->
    {% include 'includes/navbar.html' %}

    <div class="max-w-2xl mx-auto px-6 py-8">
        <div class="bg-white rounded-xl shadow-lg p-8">
            <h1 class="text-3xl font-bold text-center mb-8">Add New Event</h1>

            <form id="addEventForm" enctype="multipart/form-data">
                {% csrf_token %}
                
                <!-- Event Name -->
                <div class="mb-5">
                    <label class="block text-gray-700 font-semibold mb-2">Event Name</label>
                    <input type="text" 
                           name="name" 
                           id="name"
                           placeholder="Event name" 
                           required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#CBED98]">
                    <span class="text-red-500 text-sm" id="name-error"></span>
                </div>

                <!-- Sport Type -->
                <div class="mb-5">
                    <label class="block text-gray-700 font-semibold mb-2">Sport Type</label>
                    <select name="sport_type" 
                            id="sport_type"
                            required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#CBED98]">
                        <option value="">------</option>
                        <option value="Tennis">Tennis</option>
                        <option value="Basketball">Basketball</option>
                        <option value="Soccer">Soccer</option>
                        <option value="Badminton">Badminton</option>
                        <option value="Volleyball">Volleyball</option>
                        <option value="Futsal">Futsal</option>
                        <option value="Football">Football</option>
                        <option value="Running">Running</option>
                        <option value="Cycling">Cycling</option>
                        <option value="Swimming">Swimming</option>
                        <option value="Other">Other</option>
                    </select>
                    <span class="text-red-500 text-sm" id="sport_type-error"></span>
                </div>

                <!-- City -->
                <div class="mb-5">
                    <label class="block text-gray-700 font-semibold mb-2">City</label>
                    <input type="text" 
                           name="city" 
                           id="city"
                           placeholder="City" 
                           required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#CBED98]">
                    <span class="text-red-500 text-sm" id="city-error"></span>
                </div>

                <!-- Full Address -->
                <div class="mb-5">
                    <label class="block text-gray-700 font-semibold mb-2">Full Address</label>
                    <textarea name="full_address" 
                              id="full_address"
                              placeholder="Complete address" 
                              rows="3" 
                              required
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#CBED98]"></textarea>
                    <span class="text-red-500 text-sm" id="full_address-error"></span>
                </div>

                <!-- Entry Price -->
                <div class="mb-5">
                    <label class="block text-gray-700 font-semibold mb-2">Entry Price (IDR)</label>
                    <input type="number" 
                           name="entry_price" 
                           id="entry_price"
                           placeholder="Entry Price (IDR)" 
                           step="0.01"
                           required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#CBED98]">
                    <span class="text-red-500 text-sm" id="entry_price-error"></span>
                </div>

                <!-- Activities -->
                <div class="mb-5">
                    <label class="block text-gray-700 font-semibold mb-2">Activities (comma separated)</label>
                    <textarea name="activities" 
                              id="activities"
                              placeholder="Activities (comma separated)" 
                              rows="2" 
                              required
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#CBED98]"></textarea>
                    <span class="text-red-500 text-sm" id="activities-error"></span>
                </div>

                <!-- Rating -->
                <div class="mb-5">
                    <label class="block text-gray-700 font-semibold mb-2">Rating (optional)</label>
                    <input type="number" 
                           name="rating" 
                           id="rating"
                           placeholder="0" 
                           step="0.01"
                           min="0"
                           max="5"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#CBED98]">
                    <span class="text-red-500 text-sm" id="rating-error"></span>
                </div>

                <!-- Description -->
                <div class="mb-5">
                    <label class="block text-gray-700 font-semibold mb-2">Short description (optional)</label>
                    <textarea name="description" 
                              id="description"
                              placeholder="Short description (optional)" 
                              rows="4" 
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#CBED98]"></textarea>
                    <span class="text-red-500 text-sm" id="description-error"></span>
                </div>

                <!-- Google Maps Link -->
                <div class="mb-5">
                    <label class="block text-gray-700 font-semibold mb-2">Google Maps link</label>
                    <input type="url" 
                           name="google_maps_link" 
                           id="google_maps_link"
                           placeholder="https://maps.google.com/?q=-6.2,106.8" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#CBED98]">
                    <p class="text-xs text-gray-500 mt-1">Optional: paste a Google Maps link to update coordinates automatically</p>
                    <span class="text-red-500 text-sm" id="google_maps_link-error"></span>
                </div>

                <!-- Event Photo -->
                <div class="mb-8">
                    <label class="block text-gray-700 font-semibold mb-2">Event Photo (optional)</label>
                    <input type="file" 
                           name="photo" 
                           id="photo"
                           accept="image/*"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#CBED98]">
                    <div id="photoPreview" class="mt-4 hidden">
                        <img src="" alt="Preview" class="max-w-full h-48 object-cover rounded-lg">
                    </div>
                </div>

                <!-- Status (hidden, default Available) -->
                <input type="hidden" name="status" value="Available">

                <!-- Submit Button -->
                <button type="submit" 
                        id="submitBtn"
                        class="w-full py-4 bg-[#CBED98] text-gray-800 rounded-lg font-bold text-lg hover:bg-[#b8d687] transition">
                    Save Event
                </button>
            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg text-center">
            <div class="inline-block w-12 h-12 border-4 border-gray-300 border-t-[#CBED98] rounded-full animate-spin mb-4"></div>
            <p class="text-gray-700 font-semibold">Creating event...</p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-8 right-8 px-6 py-3 rounded-lg shadow-lg transform translate-y-32 transition-transform duration-300 z-50"></div>

    <!-- Authentication Data -->
    <script id="auth-data" type="application/json">
    {
        "isAuthenticated": {% if user.is_authenticated %}true{% else %}false{% endif %},
        "currentUserId": {% if user.is_authenticated %}{{ user.id }}{% else %}null{% endif %}
    }
    </script>

    <script>
        // Get authentication data
        const authData = JSON.parse(document.getElementById('auth-data').textContent);
        const isAuthenticated = authData.isAuthenticated;
        const currentUserId = authData.currentUserId;

        // Check authentication
        if (!isAuthenticated) {
            alert('Kamu harus login dulu!');
            window.location.href = '/login/';
        }

        // Get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed bottom-8 right-8 px-6 py-3 rounded-lg shadow-lg transform transition-transform duration-300 z-50 ${
                type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
            }`;
            toast.style.transform = 'translateY(0)';
            
            setTimeout(() => {
                toast.style.transform = 'translateY(8rem)';
            }, 3000);
        }

        // Photo preview
        document.getElementById('photo').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('photoPreview');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.querySelector('img').src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                preview.classList.add('hidden');
            }
        });

        // Form submission
        document.getElementById('addEventForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!isAuthenticated) {
                alert('Kamu harus login dulu!');
                window.location.href = '/login/';
                return;
            }

            // Clear errors
            document.querySelectorAll('[id$="-error"]').forEach(el => el.textContent = '');

            // Show loading
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('submitBtn').disabled = true;

            const formData = new FormData(this);

            try {
                const response = await fetch('{% url "event:ajax_add" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Event created successfully!', 'success');
                    setTimeout(() => {
                        window.location.href = `/event/${data.event_id}/`;
                    }, 1000);
                } else {
                    // Show errors
                    if (data.errors) {
                        Object.keys(data.errors).forEach(field => {
                            const errorEl = document.getElementById(`${field}-error`);
                            if (errorEl) {
                                errorEl.textContent = data.errors[field].join(', ');
                            }
                        });
                    }
                    showToast(data.message || 'Please fix the errors', 'error');
                    document.getElementById('loadingOverlay').classList.add('hidden');
                    document.getElementById('submitBtn').disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('An error occurred. Please try again.', 'error');
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.getElementById('submitBtn').disabled = false;
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Event - MoveBuddy</title>
    <link rel="stylesheet" href="{% static 'css/event.css' %}">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Add New Event</h1>
            <a href="{% url 'event:list' %}" class="btn-secondary">Back to Events</a>
        </div>

        <!-- Form Section -->
        <div class="form-container">
            <form id="addEventForm" enctype="multipart/form-data">
                {% csrf_token %}
                
                <!-- Event Name -->
                <div class="form-group">
                    <label for="name">Event Name *</label>
                    <input type="text" id="name" name="name" required 
                           placeholder="Enter event name" class="form-input">
                    <span class="error-message" id="name-error"></span>
                </div>

                <!-- Sport Type -->
                <div class="form-group">
                    <label for="sport_type">Sport Type *</label>
                    <select id="sport_type" name="sport_type" required class="form-input">
                        <option value="">Select sport type</option>
                        <option value="Football">Football</option>
                        <option value="Basketball">Basketball</option>
                        <option value="Badminton">Badminton</option>
                        <option value="Tennis">Tennis</option>
                        <option value="Volleyball">Volleyball</option>
                        <option value="Running">Running</option>
                        <option value="Cycling">Cycling</option>
                        <option value="Swimming">Swimming</option>
                        <option value="Other">Other</option>
                    </select>
                    <span class="error-message" id="sport_type-error"></span>
                </div>

                <!-- Description -->
                <div class="form-group">
                    <label for="description">Description *</label>
                    <textarea id="description" name="description" required 
                              rows="4" placeholder="Describe your event..." 
                              class="form-input"></textarea>
                    <span class="error-message" id="description-error"></span>
                </div>

                <!-- Location -->
                <div class="form-group">
                    <label for="location">Location *</label>
                    <input type="text" id="location" name="location" required 
                           placeholder="Event location" class="form-input">
                    <span class="error-message" id="location-error"></span>
                </div>

                <!-- Photo Upload -->
                <div class="form-group">
                    <label for="photo">Event Photo</label>
                    <input type="file" id="photo" name="photo" 
                           accept="image/*" class="form-input">
                    <small class="help-text">Optional: Upload an image for your event</small>
                    <div id="photoPreview" class="photo-preview"></div>
                </div>

                <!-- Status -->
                <div class="form-group">
                    <label for="status">Status *</label>
                    <select id="status" name="status" required class="form-input">
                        <option value="available">Available</option>
                        <option value="unavailable">Unavailable</option>
                    </select>
                </div>

                <!-- Submit Button -->
                <div class="form-actions">
                    <button type="button" onclick="window.history.back()" 
                            class="btn-secondary">Cancel</button>
                    <button type="submit" id="submitBtn" class="btn-primary">
                        Create Event
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <p>Creating event...</p>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Authentication Data -->
    <script id="auth-data" type="application/json">
    {
        "isAuthenticated": {% if request.user.is_authenticated %}true{% else %}false{% endif %},
        "currentUserId": {% if request.user.is_authenticated %}{{ request.user.id }}{% else %}null{% endif %}
    }
    </script>

    <script>
        // Get authentication data
        const authData = JSON.parse(document.getElementById('auth-data').textContent);
        const isAuthenticated = authData.isAuthenticated;
        const currentUserId = authData.currentUserId;

        // Check authentication saat page load
        if (!isAuthenticated) {
            showToast('Kamu harus login dulu!', 'error');
            setTimeout(() => {
                window.location.href = '/login/';
            }, 1500);
        }

        // Get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast toast-${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Photo preview
        document.getElementById('photo').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('photoPreview');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button type="button" onclick="clearPhoto()" class="btn-remove">Remove</button>
                    `;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        // Clear photo
        function clearPhoto() {
            document.getElementById('photo').value = '';
            document.getElementById('photoPreview').innerHTML = '';
            document.getElementById('photoPreview').style.display = 'none';
        }

        // Form submission dengan AJAX
        document.getElementById('addEventForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Check authentication lagi sebelum submit
            if (!isAuthenticated) {
                showToast('Kamu harus login dulu!', 'error');
                window.location.href = '/login/';
                return;
            }

            // Clear previous errors
            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
            document.querySelectorAll('.form-input').forEach(el => el.classList.remove('error'));

            // Show loading
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('submitBtn').disabled = true;

            // Prepare form data
            const formData = new FormData(this);

            try {
                const response = await fetch('{% url "event:ajax_add" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Event created successfully!', 'success');
                    
                    // Redirect ke detail page setelah 1 detik
                    setTimeout(() => {
                        window.location.href = `/event/${data.event_id}/`;
                    }, 1000);
                } else {
                    // Show validation errors
                    if (data.errors) {
                        Object.keys(data.errors).forEach(field => {
                            const errorEl = document.getElementById(`${field}-error`);
                            const inputEl = document.getElementById(field);
                            
                            if (errorEl && inputEl) {
                                errorEl.textContent = data.errors[field].join(', ');
                                inputEl.classList.add('error');
                            }
                        });
                    }
                    
                    showToast(data.message || 'Please fix the errors', 'error');
                    
                    // Hide loading
                    document.getElementById('loadingOverlay').style.display = 'none';
                    document.getElementById('submitBtn').disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('An error occurred. Please try again.', 'error');
                
                // Hide loading
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('submitBtn').disabled = false;
            }
        });

        // Real-time validation
        document.querySelectorAll('.form-input').forEach(input => {
            input.addEventListener('blur', function() {
                if (this.hasAttribute('required') && !this.value.trim()) {
                    this.classList.add('error');
                    const errorEl = document.getElementById(`${this.id}-error`);
                    if (errorEl) {
                        errorEl.textContent = 'This field is required';
                    }
                } else {
                    this.classList.remove('error');
                    const errorEl = document.getElementById(`${this.id}-error`);
                    if (errorEl) {
                        errorEl.textContent = '';
                    }
                }
            });
        });
    </script>
</body>
</html>