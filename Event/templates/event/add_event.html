{% load static %}
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Event - MoveBuddy</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-color: #f6f7fb;
      color: #0f172a;
    }
    .bg-form-main {
      background-image: url('{% static "img/bg.png" %}');
      background-size: cover;
      background-position: center;
      background-repeat: repeat;
    }
    .content-wrapper { position: relative; z-index: 10; }
    .glass-panel {
      background: rgba(255,255,255,0.96);
      box-shadow: 0 28px 70px rgba(15,23,42,0.10);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(148,163,184,0.25);
    }
    .input-shell {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .input-label {
      font-weight: 700;
      font-size: 0.85rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #475569;
    }
    .input-field {
      width: 100%;
      border-radius: 14px;
      border: 1px solid #e2e8f0;
      padding: 14px 16px;
      background: #fff;
      font-weight: 600;
      color: #0f172a;
      transition: all 0.2s ease;
      box-shadow: inset 0 1px 0 rgba(148,163,184,0.12);
    }
    .input-field:focus {
      outline: none;
      border-color: #a3e635;
      box-shadow: 0 0 0 4px rgba(163,230,53,0.18);
    }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 18px;
      border-radius: 9999px;
      background: #eef2ff;
      color: #4338ca;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      font-size: 0.75rem;
    }
    .section-card {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 18px;
      padding: 18px;
    }
    .schedule-pill {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 12px 14px;
      font-weight: 600;
      color: #0f172a;
    }
    .btn-primary {
      background: linear-gradient(135deg, #a3e635, #65a30d);
      color: #0f172a;
      font-weight: 800;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      border: none;
      padding: 16px 20px;
      border-radius: 14px;
      width: 100%;
      transition: all 0.2s ease;
      box-shadow: 0 14px 40px rgba(100,149,15,0.35);
    }
    .btn-primary:hover { transform: translateY(-2px); }
    .btn-ghost {
      border: 1px solid #e2e8f0;
      background: #fff;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 700;
      color: #0f172a;
      transition: all 0.2s ease;
    }
    .btn-ghost:hover { border-color: #94a3b8; }
    .divider {
      height: 1px;
      background: linear-gradient(90deg, transparent, #e2e8f0, transparent);
    }
  </style>
</head>
<body>
  {% include 'includes/navbar.html' %}
  <section class="relative min-h-screen overflow-hidden">
    <div class="bg-form-main absolute inset-0 bg-cover bg-center"></div>
    <div class="absolute inset-0 bg-white/95"></div>

    <div class="content-wrapper">
      <main class="mx-auto max-w-6xl px-4 sm:px-6 py-10 sm:py-12 space-y-8">
        <div class="text-center space-y-3">
          <div class="chip mx-auto">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6v12m-6-6h12" />
            </svg>
            Add Event
          </div>
          <h1 class="text-3xl sm:text-4xl font-black tracking-[0.18em] uppercase text-slate-900">Tambah Event Baru</h1>
          <p class="text-slate-600 font-semibold">Bantu pengguna lain menemukan dan melakukan booking dengan cepat.</p>
        </div>

        <div class="glass-panel rounded-[28px] p-6 sm:p-8">
          <form id="eventForm" method="POST" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}

            <div class="grid gap-6 md:grid-cols-2">
              <div class="input-shell">
                <label class="input-label">Event Name</label>
                <input type="text" name="name" class="input-field" placeholder="Nama event" required />
              </div>
              <div class="input-shell">
                <label class="input-label">Sport Type</label>
                <select name="sport_type" class="input-field" required>
                  <option value="">Pilih jenis olahraga</option>
                  <option value="tennis">Tennis</option>
                  <option value="basketball">Basketball</option>
                  <option value="soccer">Soccer</option>
                  <option value="badminton">Badminton</option>
                  <option value="volleyball">Volleyball</option>
                  <option value="futsal">Futsal</option>
                  <option value="paddle">Paddle</option>
                  <option value="table_tennis">Table Tennis</option>
                  <option value="swimming">Swimming</option>
                </select>
              </div>
            </div>

            <div class="grid gap-6 md:grid-cols-2">
              <div class="input-shell">
                <label class="input-label">City</label>
                <input type="text" name="city" class="input-field" placeholder="Kota" required />
              </div>
              <div class="input-shell md:col-span-1">
                <label class="input-label">Full Address</label>
                <textarea name="full_address" class="input-field" placeholder="Alamat lengkap" required rows="2"></textarea>
              </div>
            </div>

            <div class="grid gap-6 md:grid-cols-2">
              <div class="input-shell">
                <label class="input-label">Entry Price (IDR)</label>
                <input type="number" name="entry_price" class="input-field" placeholder="Contoh: 30000" step="0.01" required />
                <p class="text-xs text-slate-500 font-semibold">Akan diformat otomatis dengan tanda titik.</p>
              </div>
              <div class="input-shell">
                <label class="input-label">Rating (0-5, optional)</label>
                <input type="number" name="rating" class="input-field" placeholder="4.5" step="0.01" min="0" max="5" />
              </div>
            </div>

            <div class="grid gap-6 md:grid-cols-2">
              <div class="input-shell">
                <label class="input-label">Activities / Facilities</label>
                <input type="text" name="activities" class="input-field" placeholder="Misal: Lapangan indoor, Ruang ganti, Parkir luas" />
              </div>
              <div class="input-shell">
                <label class="input-label">Short Description</label>
                <textarea name="description" class="input-field" placeholder="Deskripsi singkat, keunggulan, dsb." rows="2"></textarea>
              </div>
            </div>

            <div class="grid gap-6 md:grid-cols-3">
              <div class="input-shell md:col-span-2">
                <label class="input-label">Google Maps Link</label>
                <input type="url" name="google_maps_link" class="input-field" placeholder="https://maps.google.com/?q=-6.2,106.8" />
                <p class="text-xs text-slate-500 font-semibold">Opsional: tempelkan link Google Maps untuk pembaruan koordinat.</p>
              </div>
              <div class="input-shell">
                <label class="input-label">Category</label>
                <input type="text" name="category" class="input-field" value="category 1" />
              </div>
            </div>

            <div class="grid gap-6 md:grid-cols-2 md:items-start">
              <div class="input-shell">
                <label class="input-label">Status</label>
                <select name="status" class="input-field">
                  <option value="available">Available</option>
                  <option value="unavailable">Unavailable</option>
                </select>
              </div>
              <div class="grid gap-4 sm:grid-cols-2 sm:items-start">
                <div class="input-shell sm:col-span-1">
                  <label class="input-label">Photo URL (opsional)</label>
                  <input id="photoUrlInput" name="photo_url" type="url" class="input-field" placeholder="Tempel URL gambar jika ada" />
                  <p class="text-[11px] text-slate-500 font-semibold">Jika tidak ada file, kami ambil gambar dari URL ini.</p>
                </div>
                <div class="input-shell sm:col-span-1">
                  <label class="input-label">Upload Photo</label>
                  <input type="file" name="photo" class="input-field" accept="image/*" />
                </div>
              </div>
            </div>

            <div class="section-card space-y-3">
              <div class="flex items-center justify-between flex-wrap gap-3">
                <div>
                  <p class="text-xs font-black uppercase tracking-[0.2em] text-slate-500">Jadwal Event</p>
                  <p class="text-sm text-slate-600 font-semibold">Tambahkan tanggal yang tersedia untuk booking.</p>
                </div>
                <div class="flex items-center gap-2">
                  <input type="date" id="newDateInput" class="input-field w-44" />
                  <button type="button" onclick="addDate()" class="btn-ghost text-sm uppercase tracking-[0.12em]">+ Tambah Tanggal</button>
                </div>
              </div>
              <div id="datesList" class="flex flex-wrap gap-3">
                <div class="text-slate-400 text-sm font-semibold italic">Belum ada tanggal.</div>
              </div>
            </div>

            <input type="hidden" name="schedule_dates" id="scheduleDates" value="[]">

            <div class="divider"></div>

            <button type="submit" class="btn-primary">Simpan Event</button>
          </form>
        </div>
      </main>
    </div>
  </section>

  <script>
    let eventDates = [];

    function setHiddenDates() {
      document.getElementById('scheduleDates').value = JSON.stringify(eventDates);
    }

    function renderDates() {
      const list = document.getElementById('datesList');
      if (!eventDates.length) {
        list.innerHTML = '<div class="text-slate-400 text-sm font-semibold italic">Belum ada tanggal.</div>';
      } else {
        const sorted = [...eventDates].sort();
        list.innerHTML = sorted.map(date => {
          const readable = new Date(date + 'T00:00:00').toLocaleDateString('id-ID', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
          });
          return `
            <div class="schedule-pill">
              <span>${readable}</span>
              <button type="button" class="text-rose-600 font-bold" onclick="removeDate('${date}')">Hapus</button>
            </div>
          `;
        }).join('');
      }
      setHiddenDates();
    }

    function addDate() {
      const input = document.getElementById('newDateInput');
      const value = input.value;
      if (!value) return alert('Pilih tanggal terlebih dahulu.');
      if (eventDates.includes(value)) return alert('Tanggal sudah ditambahkan.');
      eventDates.push(value);
      renderDates();
      input.value = '';
    }

    function removeDate(date) {
      eventDates = eventDates.filter(d => d !== date);
      renderDates();
    }

    document.addEventListener('DOMContentLoaded', renderDates);

    document.getElementById('eventForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      // Auto-capture typed date if user didn't hit the add button
      const dateInput = document.getElementById('newDateInput');
      const pendingDate = dateInput?.value;
      // Only auto-capture typed date if none added yet (avoid unintended extra date)
      if (!eventDates.length && pendingDate && !eventDates.includes(pendingDate)) {
        eventDates.push(pendingDate);
        renderDates();
      }
      if (dateInput) {
        dateInput.value = '';
        dateInput.blur();
      }

      if (!eventDates.length) {
        alert('Please add at least one event date');
        return;
      }
      const formData = new FormData(this);
      formData.set('schedule_dates', JSON.stringify(eventDates));

      const fileInput = this.querySelector('input[name=\"photo\"]');
      const file = fileInput?.files?.[0];
      const photoUrl = document.getElementById('photoUrlInput')?.value.trim();

      if (!file && photoUrl) {
        try {
          const response = await fetch(photoUrl);
          if (!response.ok) throw new Error('Gagal mengambil gambar dari URL');
          const blob = await response.blob();
          const ext = (blob.type && blob.type.split('/')[1]) || 'jpg';
          const filename = `event-photo.${ext}`;
          formData.set('photo', new File([blob], filename, { type: blob.type || 'image/jpeg' }));
        } catch (err) {
          alert(err.message || 'Gagal memuat foto dari URL, coba unggah manual.');
          return;
        }
      }

      fetch('{% url "event:add_event" %}', {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert('Event created successfully!');
          window.location.href = data.redirect_url || '/event/';
        } else {
          let msg = 'Failed to create event';
          if (data.errors) {
            msg += ':\n';
            for (const field in data.errors) {
              msg += `${field}: ${data.errors[field]}\n`;
            }
          }
          alert(msg);
        }
      })
      .catch(() => alert('An error occurred. Please try again.'));
    });
  </script>
</body>
</html>
