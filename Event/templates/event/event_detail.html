{% extends 'base.html' %}
{% load static %}
{% load event_extras %}
{% block meta %}
<title>{{ event.name }} - MoveBuddy Event Detail</title>
<style>
    .bg-detail-main {
        background-image: url('{% static "img/bg.png" %}');
        background-size: cover;
        background-position: center;
    }
    
    .sport-tennis { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }
    .sport-basketball { background: linear-gradient(135deg, #fb923c 0%, #ea580c 100%); }
    .sport-soccer { background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%); }
    .sport-badminton { background: linear-gradient(135deg, #a3e635 0%, #84cc16 100%); }
    .sport-volleyball { background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); }
    .sport-futsal { background: linear-gradient(135deg, #facc15 0%, #eab308 100%); }
    .sport-paddle { background: linear-gradient(135deg, #c084fc 0%, #a855f7 100%); }
    .sport-table_tennis { background: linear-gradient(135deg, #f472b6 0%, #ec4899 100%); }
    .sport-swimming { background: linear-gradient(135deg, #67e8f9 0%, #06b6d4 100%); }
    
    .sport-emoji {
        font-size: 64px;
        margin-bottom: 12px;
    }
    
    .sport-badge {
        background: rgba(255, 255, 255, 0.95);
        color: #1a1a1a;
        padding: 8px 20px;
        border-radius: 50px;
        font-size: 13px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-block;
        margin-bottom: 16px;
    }
    
    .event-title-header {
        font-size: 32px;
        font-weight: 800;
        color: white;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
</style>
{% endblock meta %}

{% block content %}
<section class="relative min-h-screen overflow-hidden py-12">
  <div class="bg-detail-main absolute inset-0 bg-cover bg-center"></div>
  <div class="absolute inset-0 bg-white/95"></div>

  <div class="relative z-10">
    {% include 'includes/navbar.html' %}
    <div class="mx-auto w-full max-w-7xl space-y-6 px-5 sm:px-10">
      <a href="{% url 'event:event_list' %}" class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white/90 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-slate-600 transition hover:-translate-y-0.5 hover:border-slate-300 hover:text-slate-900">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m15 19-7-7 7-7" />
        </svg>
        Back to Event List
      </a>

      <article class="overflow-hidden rounded-[2.5rem] bg-white/95 shadow-[0_32px_80px_rgba(15,23,42,0.12)] backdrop-blur">
        <div class="relative h-64 sport-{{ event.sport_type }}">
          <div class="flex h-full flex-col items-center justify-center text-center">
            <div class="sport-emoji">{{ event.sport_type|get_sport_emoji }}</div>
            <div class="sport-badge">{{ event.get_sport_type_display }}</div>
            <h1 class="event-title-header">{{ event.name }}</h1>
          </div>
        </div>

        <div class="grid gap-8 px-6 py-8 md:px-10 md:py-10 lg:grid-cols-[1.6fr_1fr]">
          <div class="space-y-8">
            <header class="space-y-4">
              <div class="flex flex-wrap items-center gap-3">
                <span class="inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] {% if event.status == 'available' %}border-emerald-200 bg-emerald-100 text-emerald-700{% else %}border-rose-200 bg-rose-100 text-rose-700{% endif %}">
                  {% if event.status == 'available' %}Available{% else %}Unavailable{% endif %}
                </span>
                <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white/80 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
                  <span class="inline-flex">
                    {% with event.rating|default:0 as rating %}
                      {% for i in "12345" %}
                        {% if forloop.counter <= rating %}
                          <svg class="h-4 w-4 text-amber-400" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                        {% else %}
                          <svg class="h-4 w-4 text-slate-300" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                        {% endif %}
                      {% endfor %}
                    {% endwith %}
                  </span>
                  <span class="text-slate-600">{{ event.rating|default:"0.0"|floatformat:1 }}/5.0</span>
                </span>
              </div>

              <div>
                <p class="mt-2 text-sm font-semibold uppercase tracking-[0.28em] text-slate-500">
                  {{ event.get_sport_type_display }} ‚Ä¢ {{ event.city }}
                </p>
              </div>
            </header>

            {% if event.description %}
            <section class="space-y-3">
              <h2 class="flex items-center gap-2 text-sm font-semibold uppercase tracking-[0.28em] text-slate-600">
                <span>üìÑ</span> Description
              </h2>
              <div class="rounded-2xl border border-slate-200 bg-slate-50/80 p-5 text-sm leading-relaxed text-slate-600">
                {{ event.description }}
              </div>
            </section>
            {% endif %}

            <div class="grid gap-6 md:grid-cols-2">
              <section class="space-y-3">
                <h2 class="flex items-center gap-2 text-sm font-semibold uppercase tracking-[0.28em] text-slate-600">
                  <span>üìç</span> Address
                </h2>
                <div class="rounded-2xl border border-slate-200 bg-slate-50/80 p-5 text-sm text-slate-600">
                  {{ event.address|default:"Tidur" }}
                </div>
              </section>
              <section class="space-y-3">
                <h2 class="flex items-center gap-2 text-sm font-semibold uppercase tracking-[0.28em] text-slate-600">
                  <span>‚ú®</span> Activities & Facilities
                </h2>
                <div class="flex flex-wrap gap-3 rounded-2xl border border-slate-200 bg-slate-50/80 p-5">
                  {% if event.activities_and_facilities %}
                    {% for facility in event.activities_and_facilities.split %}
                    <span class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-600 shadow-inner">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-emerald-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M16.704 5.29a1 1 0 0 1 .005 1.414l-7.428 7.5a1 1 0 0 1-1.437-.01L3.29 9.414a1 1 0 1 1 1.42-1.406l3.12 3.152 6.714-6.78a1 1 0 0 1 1.414-.01Z" clip-rule="evenodd" />
                      </svg>
                      {{ facility }}
                    </span>
                    {% endfor %}
                  {% else %}
                    <span class="text-sm text-slate-400">Tidur</span>
                  {% endif %}
                </div>
              </section>
            </div>
          </div>

          <aside class="space-y-6">
            <div class="rounded-3xl bg-gradient-to-br from-slate-900 to-slate-950 px-6 py-6 text-white shadow-lg">
              <span class="text-xs font-semibold uppercase tracking-[0.3em] text-white/70">Price per Hour</span>
              <p class="mt-3 text-3xl font-bold tracking-[0.15em]">IDR {{ event.entry_price|rupiah }}</p>
            </div>

            <div class="rounded-3xl border border-slate-200 bg-white/95 p-6 shadow-[0_18px_40px_rgba(15,23,42,0.06)] space-y-5">
              <div class="space-y-4">
                <h3 class="text-sm font-semibold uppercase tracking-[0.28em] text-slate-600">Join Event</h3>
                
                <div class="flex items-center gap-3 rounded-2xl border border-slate-200 bg-slate-50 px-5 py-3 text-sm font-semibold text-slate-800">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-sky-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.5 20.118a7.5 7.5 0 0 1 15 0A17.933 17.933 0 0 1 12 21.75c-2.68 0-5.216-.584-7.5-1.632Z" />
                  </svg>
                  <span>{{ event.organizer.email }}</span>
                </div>

                {% if schedules %}
                <div class="flex flex-col gap-2">
                  <label for="scheduleSelect" class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-600">Select Available Date</label>
                  <select id="scheduleSelect" class="w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 shadow-inner outline-none transition focus:border-lime-300 focus:ring-4 focus:ring-lime-200/60">
                    <option value="">-- Choose a date --</option>
                    {% for schedule in schedules %}
                    <option value="{{ schedule.pk_event_sched }}" data-date="{{ schedule.date|date:'l, d F Y' }}">
                      {{ schedule.date|date:"l, d F Y" }}
                    </option>
                    {% endfor %}
                  </select>
                </div>

                <div id="dateInfo" class="rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm font-semibold text-slate-600">
                  Please select a date to join the event
                </div>

                {% if user %}
                  {% if user.id == event.organizer.id %}
                    <div class="rounded-2xl border border-amber-200 bg-amber-50 px-4 py-3 text-sm font-semibold text-amber-700">
                      ‚ú® You are the organizer of this event
                    </div>
                  {% else %}
                    <button id="joinBtn" class="w-full rounded-2xl bg-emerald-500 px-6 py-3 text-sm font-semibold uppercase tracking-[0.3em] text-white transition hover:-translate-y-0.5 hover:bg-emerald-600 disabled:cursor-not-allowed disabled:opacity-60" onclick="joinEvent()" disabled>
                      Join Event
                    </button>
                    
                    {% if user_registered %}
                    <button class="w-full rounded-2xl border border-rose-300 bg-rose-50 px-6 py-3 text-sm font-semibold uppercase tracking-[0.3em] text-rose-700 transition hover:-translate-y-0.5 hover:bg-rose-100" onclick="cancelRegistration()">
                      Cancel Registration
                    </button>
                    {% endif %}
                  {% endif %}
                {% else %}
                  <a href="{% url 'Auth_Profile:login' %}?next={{ request.path }}" class="block w-full rounded-2xl bg-slate-600 px-6 py-3 text-center text-sm font-semibold uppercase tracking-[0.3em] text-white transition hover:-translate-y-0.5 hover:bg-slate-700">
                    Login to Join
                  </a>
                {% endif %}
                {% else %}
                <div class="rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-600">
                  No available schedules at the moment
                </div>
                {% endif %}

                {% if user and user.id == event.organizer.id %}
                <div class="flex flex-wrap gap-2 pt-4 border-t border-slate-200">
                  <button type="button" class="flex items-center justify-center rounded-xl border border-emerald-300 bg-emerald-50 px-3 py-2 text-xs font-semibold text-emerald-700 transition hover:-translate-y-0.5 hover:shadow-lg hover:shadow-emerald-200/40 min-w-[130px]" onclick="toggleAvailability(true)">
                    Mark Available
                  </button>
                  <button type="button" class="flex items-center justify-center rounded-xl border border-rose-300 bg-rose-50 px-3 py-2 text-xs font-semibold text-rose-700 transition hover:-translate-y-0.5 hover:shadow-lg hover:shadow-rose-200/40 min-w-[130px]" onclick="toggleAvailability(false)">
                    Mark Unavailable
                  </button>
                  <button type="button" class="flex items-center justify-center rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs font-semibold uppercase tracking-[0.25em] text-slate-700 transition hover:-translate-y-0.5 hover:border-slate-300 hover:text-slate-900" onclick="window.location.href='{% url "event:edit_event" event.id %}'">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M4 13.5V16h2.5L15.374 7.126 12.874 4.626 4 13.5Zm12.915-7.915a.997.997 0 0 0 0-1.414l-1.586-1.586a.999.999 0 0 0-1.414 0L12.586 3.5l3.5 3.5.829-.415Z"/></svg>
                  </button>
                  <button type="button" class="flex items-center justify-center rounded-lg border border-rose-300 bg-white px-3 py-2 text-xs font-semibold uppercase tracking-[0.25em] text-rose-600 transition hover:-translate-y-0.5 hover:bg-rose-50" onclick="deleteEvent()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M6 7a1 1 0 0 1 1 1v7a1 1 0 1 1-2 0V8a1 1 0 0 1 1-1Zm4 0a1 1 0 0 1 1 1v7a1 1 0 1 1-2 0V8a1 1 0 0 1 1-1Zm5-4h-3.5l-1-1h-4l-1 1H2v2h16V3h-3Z"/><path d="M4 6h12v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6Z"/></svg>
                  </button>
                </div>
                {% endif %}

                <a href="https://wa.me/?text=Join%20event%20{{ event.name|urlencode }}%20at%20{{ event.city|urlencode }}" target="_blank" class="block w-full rounded-2xl bg-emerald-500 px-6 py-3 text-center text-sm font-semibold uppercase tracking-[0.3em] text-white transition hover:-translate-y-0.5 hover:bg-emerald-600">
                  üí¨ Share via WhatsApp
                </a>
              </div>
            </div>
          </aside>
        </div>
      </article>
    </div>
  </div>
</section>

<script>
  const scheduleSelect = document.getElementById('scheduleSelect');
  const joinBtn = document.getElementById('joinBtn');
  const dateInfo = document.getElementById('dateInfo');
  
  if (scheduleSelect && joinBtn) {
    scheduleSelect.addEventListener('change', function() {
      if (this.value) {
        joinBtn.disabled = false;
        const selectedOption = this.options[this.selectedIndex];
        const dateText = selectedOption.getAttribute('data-date');
        dateInfo.textContent = 'Event available on ' + dateText;
        dateInfo.classList.remove('border-slate-200', 'bg-slate-50', 'text-slate-600');
        dateInfo.classList.add('border-emerald-200', 'bg-emerald-50', 'text-emerald-700');
      } else {
        joinBtn.disabled = true;
        dateInfo.textContent = 'Please select a date to join the event';
        dateInfo.classList.remove('border-emerald-200', 'bg-emerald-50', 'text-emerald-700');
        dateInfo.classList.add('border-slate-200', 'bg-slate-50', 'text-slate-600');
      }
    });
  }
  
  function joinEvent() {
    const scheduleId = scheduleSelect.value;
    if (!scheduleId) {
      alert('Please select a date first');
      return;
    }
    
    if (confirm('Join this event?')) {
      fetch('/event/{{ event.id }}/ajax/join/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}',
          'X-Requested-With': 'XMLHttpRequest',
        },
        body: JSON.stringify({
          schedule_id: scheduleId
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          location.reload();
        } else {
          alert('Error: ' + (data.message || 'Failed to join event'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
      });
    }
  }
  
  function cancelRegistration() {
    if (confirm('Are you sure you want to cancel your registration for this event?')) {
      fetch('/event/{{ event.id }}/ajax/cancel/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}',
          'X-Requested-With': 'XMLHttpRequest',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          location.reload();
        } else {
          alert('Error: ' + (data.message || 'Failed to cancel registration'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
      });
    }
  }
  
  function toggleAvailability(isAvailable) {
    const action = isAvailable ? 'available' : 'unavailable';
    
    if (confirm('Mark this event as ' + action + '?')) {
      fetch('/event/{{ event.id }}/ajax/toggle-availability/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}',
          'X-Requested-With': 'XMLHttpRequest',
        },
        body: JSON.stringify({
          is_available: isAvailable
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          location.reload();
        } else {
          alert('Error: ' + (data.message || 'Failed to update availability'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
      });
    }
  }
  
  function deleteEvent() {
    if (confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
      fetch('/event/{{ event.id }}/ajax/delete/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}',
          'X-Requested-With': 'XMLHttpRequest',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          window.location.href = '/event/';
        } else {
          alert('Error: ' + (data.message || 'Failed to delete event'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
      });
    }
  }
</script>
{% endblock content %}
