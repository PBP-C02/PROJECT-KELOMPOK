{% load static %}
{% load event_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ event.name }} - MoveBuddy</title>
    <link rel="stylesheet" href="{% static 'css/globals.css' %}">
    <link rel="stylesheet" href="{% static 'css/event.css' %}">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <!-- Include Navbar -->
    {% include 'includes/navbar.html' %}

    <div class="max-w-4xl mx-auto px-6 py-8">
        <div class="mb-4">
            <a href="{% url 'event:list' %}" 
               class="inline-block px-6 py-2 bg-gray-800 text-white rounded-lg font-semibold hover:bg-gray-700 transition">
                Back to Event List
            </a>
        </div>

        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <!-- Event Banner -->
            <div class="relative h-64">
                {% if event.photo %}
                <img src="{{ event.photo.url }}" alt="{{ event.name }}" class="w-full h-full object-cover">
                {% else %}
                <div class="w-full h-full bg-gradient-to-br from-red-500 to-red-700 flex items-center justify-center">
                    <span class="text-9xl font-bold text-white">{{ event.name|slice:":4"|upper }}</span>
                </div>
                {% endif %}
            </div>

            <!-- Event Details -->
            <div class="p-8">
                <div class="flex items-start justify-between mb-6">
                    <div>
                        <span class="inline-block px-4 py-1 text-sm font-semibold rounded-full mb-3
                            {% if event.status == 'Available' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                            {{ event.status }}
                        </span>
                        <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ event.name }}</h1>
                        <p class="text-gray-600">{{ event.sport_type }} · Rating: {{ event.rating|default:"0.00" }} · Location: {{ event.city }}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-600 mb-1">Harga per JAM</p>
                        <p class="text-3xl font-bold text-gray-900">IDR {{ event.entry_price|floatformat:0 }}</p>
                    </div>
                </div>

                <!-- Address -->
                <div class="mb-6">
                    <h3 class="font-bold text-gray-900 mb-2">Address</h3>
                    <p class="text-gray-700">{{ event.full_address }}</p>
                </div>

                <!-- Category -->
                <div class="mb-8">
                    <h3 class="font-bold text-gray-900 mb-2">[ category ]</h3>
                    <div class="flex flex-wrap gap-2">
                        {% for activity in event.activities|split:',' %}
                        <span class="px-3 py-1 bg-gray-200 text-gray-800 rounded-full text-sm">{{ activity|strip }}</span>
                        {% endfor %}
                    </div>
                </div>

                <!-- Join Event Section -->
                {% if user.is_authenticated %}
                <div class="bg-gray-50 rounded-lg p-6 mb-6">
                    <h3 class="font-bold text-gray-900 mb-4">Join Event</h3>
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 mb-1">user</p>
                        <p class="font-semibold text-gray-900">{{ user.username }}</p>
                        <p class="text-sm text-gray-600 mt-2">Event Holder</p>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Select Date:</label>
                        <input type="text" 
                               id="eventDate" 
                               readonly 
                               placeholder="10 / 23 / 2025"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white cursor-pointer">
                    </div>

                    <p class="text-sm text-gray-600 mb-4">
                        Event available on Kamis, 23 Oktober 2025
                    </p>

                    <!-- Action Buttons (Owner Only) -->
                    {% if user == event.created_by %}
                    <div class="flex flex-wrap gap-3 mb-4">
                        {% if event.status == 'Available' %}
                        <button onclick="toggleAvailability('Unavailable')" 
                                class="px-4 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition">
                            Mark Unavailable
                        </button>
                        {% else %}
                        <button onclick="toggleAvailability('Available')" 
                                class="px-4 py-2 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition">
                            Mark Available
                        </button>
                        {% endif %}
                        <button onclick="deleteEvent()" 
                                class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition">
                            Delete Event
                        </button>
                        <a href="{% url 'event:edit' event.id %}" 
                           class="px-4 py-2 bg-[#CBED98] text-gray-800 rounded-lg font-semibold hover:bg-[#b8d687] transition">
                            Edit Event
                        </a>
                    </div>
                    {% endif %}

                    <button id="joinButton" 
                            onclick="joinEvent()" 
                            class="w-full py-4 bg-green-500 text-white rounded-lg font-bold text-lg hover:bg-green-600 transition">
                        Join via WhatsApp
                    </button>
                </div>
                {% else %}
                <div class="bg-gray-50 rounded-lg p-6 mb-6 text-center">
                    <p class="text-gray-700 mb-4">Please login to join this event</p>
                    <a href="/login/" 
                       class="inline-block px-6 py-2 bg-[#CBED98] text-gray-800 rounded-lg font-semibold hover:bg-[#b8d687] transition">
                        Login
                    </a>
                </div>
                {% endif %}

                <!-- Who's Joining -->
                {% if registrations %}
                <div class="mt-8">
                    <h3 class="font-bold text-gray-900 mb-4">Who's Joining?</h3>
                    <div class="space-y-2">
                        {% for reg in registrations %}
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <span class="font-semibold text-gray-900">{{ reg.user.username }}</span>
                            <span class="text-sm text-gray-600">{{ reg.selected_date|date:"M d, Y" }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-8 right-8 px-6 py-3 rounded-lg shadow-lg transform translate-y-32 transition-transform duration-300 z-50"></div>

    <!-- Authentication Data -->
    <script id="auth-data" type="application/json">
    {
        "isAuthenticated": {% if user.is_authenticated %}true{% else %}false{% endif %},
        "currentUserId": {% if user.is_authenticated %}{{ user.id }}{% else %}null{% endif %},
        "eventOwnerId": {{ event.created_by.id }}
    }
    </script>

    <script>
        // Get authentication data
        const authData = JSON.parse(document.getElementById('auth-data').textContent);
        const isAuthenticated = authData.isAuthenticated;
        const currentUserId = authData.currentUserId;
        const eventOwnerId = authData.eventOwnerId;

        // Get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed bottom-8 right-8 px-6 py-3 rounded-lg shadow-lg transform transition-transform duration-300 z-50 ${
                type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
            }`;
            toast.style.transform = 'translateY(0)';
            
            setTimeout(() => {
                toast.style.transform = 'translateY(8rem)';
            }, 3000);
        }

        // Date selector
        document.getElementById('eventDate')?.addEventListener('click', function() {
            if (!isAuthenticated) {
                showToast('Login dulu bro!', 'error');
                window.location.href = '/login/';
                return;
            }

            const tempInput = document.createElement('input');
            tempInput.type = 'date';
            tempInput.style.position = 'absolute';
            tempInput.style.opacity = '0';
            document.body.appendChild(tempInput);
            
            tempInput.addEventListener('change', function() {
                const selectedDate = new Date(this.value);
                const formattedDate = `${selectedDate.getMonth() + 1}/${selectedDate.getDate()}/${selectedDate.getFullYear()}`;
                document.getElementById('eventDate').value = formattedDate;
                document.body.removeChild(tempInput);
            });
            
            tempInput.click();
        });

        // Join Event
        async function joinEvent() {
            if (!isAuthenticated) {
                showToast('Login dulu bro!', 'error');
                window.location.href = '/login/';
                return;
            }

            const dateValue = document.getElementById('eventDate').value;
            
            if (!dateValue) {
                showToast('Pilih tanggal dulu!', 'error');
                return;
            }

            const joinButton = document.getElementById('joinButton');
            joinButton.disabled = true;
            joinButton.textContent = 'Processing...';

            try {
                const response = await fetch('{% url "event:ajax_join" event.id %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        date: dateValue
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    setTimeout(() => {
                        const message = encodeURIComponent(`Hi! Gw mau join event: {{ event.name }} tanggal ${dateValue}`);
                        window.open(`https://wa.me/?text=${message}`, '_blank');
                        joinButton.disabled = false;
                        joinButton.textContent = 'Join via WhatsApp';
                    }, 1000);
                } else {
                    showToast(data.message, 'error');
                    joinButton.disabled = false;
                    joinButton.textContent = 'Join via WhatsApp';
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('An error occurred', 'error');
                joinButton.disabled = false;
                joinButton.textContent = 'Join via WhatsApp';
            }
        }

        // Toggle Availability
        async function toggleAvailability(status) {
            if (!isAuthenticated || currentUserId !== eventOwnerId) {
                showToast('Kamu bukan owner event ini!', 'error');
                return;
            }

            if (!confirm(`Yakin mau mark event ini jadi ${status}?`)) {
                return;
            }

            try {
                const response = await fetch('{% url "event:ajax_toggle_availability" event.id %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        status: status
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('An error occurred', 'error');
            }
        }

        // Delete Event
        async function deleteEvent() {
            if (!isAuthenticated || currentUserId !== eventOwnerId) {
                showToast('Kamu bukan owner event ini!', 'error');
                return;
            }

            if (!confirm('Yakin mau delete event ini? Ga bisa di-undo!')) {
                return;
            }

            try {
                const response = await fetch('{% url "event:ajax_delete" event.id %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Event deleted!', 'success');
                    setTimeout(() => {
                        window.location.href = '/event/';
                    }, 1000);
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('An error occurred', 'error');
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ event.name }} - MoveBuddy</title>
    <link rel="stylesheet" href="{% static 'css/event.css' %}">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Event Details</h1>
            <a href="{% url 'event:list' %}" class="btn-secondary">Back to Events</a>
        </div>

        <!-- Event Detail Card -->
        <div class="event-detail-card">
            <!-- Event Image -->
            <div class="event-detail-image">
                {% if event.photo %}
                <img src="{{ event.photo.url }}" alt="{{ event.name }}">
                {% else %}
                <div class="event-detail-placeholder">
                    <span>{{ event.sport_type|slice:":1" }}</span>
                </div>
                {% endif %}
            </div>

            <!-- Event Info -->
            <div class="event-detail-content">
                <!-- Title & Status -->
                <div class="event-detail-header">
                    <h2>{{ event.name }}</h2>
                    <span class="status-badge status-{{ event.status }}">
                        {{ event.get_status_display }}
                    </span>
                </div>

                <!-- Sport Type -->
                <div class="event-info-row">
                    <span class="info-label">Sport Type:</span>
                    <span class="info-value">{{ event.sport_type }}</span>
                </div>

                <!-- Location -->
                <div class="event-info-row">
                    <span class="info-label">Location:</span>
                    <span class="info-value">{{ event.location }}</span>
                </div>

                <!-- Creator -->
                <div class="event-info-row">
                    <span class="info-label">Created by:</span>
                    <span class="info-value">{{ event.created_by.username }}</span>
                </div>

                <!-- Created Date -->
                <div class="event-info-row">
                    <span class="info-label">Created:</span>
                    <span class="info-value">{{ event.created_at|date:"F d, Y" }}</span>
                </div>

                <!-- Description -->
                <div class="event-description-section">
                    <h3>Description</h3>
                    <p>{{ event.description }}</p>
                </div>

                <!-- Join Event Section -->
                {% if request.user.is_authenticated %}
                    {% if event.status == 'available' %}
                    <div class="join-section">
                        <h3>Join This Event</h3>
                        <div class="date-selector">
                            <label for="eventDate">Select Date:</label>
                            <input type="text" id="eventDate" readonly 
                                   placeholder="Click to select date" 
                                   class="form-input">
                            <button type="button" id="selectDateBtn" 
                                    onclick="selectDate()" 
                                    class="btn-secondary">
                                Select Date
                            </button>
                        </div>
                        <button type="button" id="joinButton" 
                                onclick="joinEvent()" 
                                class="btn-primary btn-large">
                            Join via WhatsApp
                        </button>
                    </div>
                    {% else %}
                    <div class="unavailable-notice">
                        <p>This event is currently unavailable</p>
                    </div>
                    {% endif %}
                {% else %}
                <div class="login-notice">
                    <p>Please <a href="/login/">login</a> to join this event</p>
                </div>
                {% endif %}

                <!-- Owner Actions -->
                {% if request.user == event.created_by %}
                <div class="owner-actions">
                    <h3>Event Management</h3>
                    <div class="action-buttons">
                        <a href="{% url 'event:edit' event.id %}" class="btn-primary">
                            Edit Event
                        </a>
                        {% if event.status == 'available' %}
                        <button type="button" onclick="toggleAvailability('unavailable')" 
                                class="btn-warning">
                            Mark as Unavailable
                        </button>
                        {% else %}
                        <button type="button" onclick="toggleAvailability('available')" 
                                class="btn-success">
                            Mark as Available
                        </button>
                        {% endif %}
                        <button type="button" onclick="deleteEvent()" 
                                class="btn-danger">
                            Delete Event
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Event Registrations -->
        {% if registrations %}
        <div class="registrations-section">
            <h3>Who's Joining?</h3>
            <div class="registration-list">
                {% for reg in registrations %}
                <div class="registration-item">
                    <span class="reg-user">{{ reg.user.username }}</span>
                    <span class="reg-date">{{ reg.selected_date|date:"M d, Y" }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Authentication Data -->
    <script id="auth-data" type="application/json">
    {
        "isAuthenticated": {% if request.user.is_authenticated %}true{% else %}false{% endif %},
        "currentUserId": {% if request.user.is_authenticated %}{{ request.user.id }}{% else %}null{% endif %},
        "eventOwnerId": {{ event.created_by.id }}
    }
    </script>

    <script>
        // Get authentication data
        const authData = JSON.parse(document.getElementById('auth-data').textContent);
        const isAuthenticated = authData.isAuthenticated;
        const currentUserId = authData.currentUserId;
        const eventOwnerId = authData.eventOwnerId;

        // Get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast toast-${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Date selector function
        function selectDate() {
            if (!isAuthenticated) {
                showToast('Login dulu bro!', 'error');
                window.location.href = '/login/';
                return;
            }

            const dateInput = document.getElementById('eventDate');
            const selectBtn = document.getElementById('selectDateBtn');
            
            // Disable button
            selectBtn.disabled = true;
            selectBtn.textContent = 'Opening...';
            
            // Create temporary date input
            const tempInput = document.createElement('input');
            tempInput.type = 'date';
            tempInput.style.position = 'absolute';
            tempInput.style.opacity = '0';
            document.body.appendChild(tempInput);
            
            tempInput.addEventListener('change', function() {
                const selectedDate = new Date(this.value);
                const formattedDate = `${selectedDate.getMonth() + 1}/${selectedDate.getDate()}/${selectedDate.getFullYear()}`;
                dateInput.value = formattedDate;
                document.body.removeChild(tempInput);
                
                // Re-enable button
                selectBtn.disabled = false;
                selectBtn.textContent = 'Select Date';
            });
            
            // Kalo user cancel
            tempInput.addEventListener('blur', function() {
                setTimeout(() => {
                    if (document.body.contains(tempInput)) {
                        document.body.removeChild(tempInput);
                        selectBtn.disabled = false;
                        selectBtn.textContent = 'Select Date';
                    }
                }, 200);
            });
            
            tempInput.click();
        }

        // Join Event Function
        async function joinEvent() {
            if (!isAuthenticated) {
                showToast('Login dulu bro!', 'error');
                window.location.href = '/login/';
                return;
            }

            const dateValue = document.getElementById('eventDate').value;
            
            if (!dateValue) {
                showToast('Pilih tanggal dulu bro!', 'error');
                return;
            }

            const joinButton = document.getElementById('joinButton');
            joinButton.disabled = true;
            joinButton.textContent = 'Processing...';

            try {
                const response = await fetch('{% url "event:ajax_join" event.id %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        date: dateValue
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    
                    // Redirect ke WhatsApp setelah 1 detik
                    setTimeout(() => {
                        const message = encodeURIComponent(`Hi! Gw mau join event: {{ event.name }} tanggal ${dateValue}`);
                        window.open(`https://wa.me/?text=${message}`, '_blank');
                        
                        // Reset button
                        joinButton.disabled = false;
                        joinButton.textContent = 'Join via WhatsApp';
                    }, 1000);
                } else {
                    showToast(data.message, 'error');
                    joinButton.disabled = false;
                    joinButton.textContent = 'Join via WhatsApp';
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('An error occurred. Please try again.', 'error');
                joinButton.disabled = false;
                joinButton.textContent = 'Join via WhatsApp';
            }
        }

        // Toggle Availability Function
        async function toggleAvailability(status) {
            if (!isAuthenticated) {
                showToast('Login dulu bro!', 'error');
                window.location.href = '/login/';
                return;
            }

            if (currentUserId !== eventOwnerId) {
                showToast('Kamu bukan owner event ini!', 'error');
                return;
            }

            if (!confirm(`Yakin mau mark event ini jadi ${status}?`)) {
                return;
            }

            try {
                const response = await fetch('{% url "event:ajax_toggle_availability" event.id %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        status: status
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    
                    // Update status badge
                    const statusBadge = document.querySelector('.status-badge');
                    statusBadge.className = `status-badge status-${data.status}`;
                    statusBadge.textContent = data.status === 'available' ? 'Available' : 'Unavailable';
                    
                    // Reload page setelah 1 detik
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('An error occurred. Please try again.', 'error');
            }
        }

        // Delete Event Function
        async function deleteEvent() {
            if (!isAuthenticated) {
                showToast('Login dulu bro!', 'error');
                window.location.href = '/login/';
                return;
            }

            if (currentUserId !== eventOwnerId) {
                showToast('Kamu bukan owner event ini!', 'error');
                return;
            }

            if (!confirm('Yakin mau delete event ini? Ga bisa di-undo loh!')) {
                return;
            }

            try {
                const response = await fetch('{% url "event:ajax_delete" event.id %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Event deleted successfully!', 'success');
                    
                    // Redirect ke event list setelah 1 detik
                    setTimeout(() => {
                        window.location.href = '/event/';
                    }, 1000);
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('An error occurred. Please try again.', 'error');
            }
        }
    </script>
</body>
</html>